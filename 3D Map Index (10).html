<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaria Heroes: Save Nyanja Village</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Quicksand:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Rajdhani:wght@500;700&family=Orbitron:wght@500;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap');

        :root {
            --hero-blue: #3b82f6;
            --victory-green: #10b981;
            --warning-amber: #f59e0b;
            --danger-red: #ef4444;
            --neutral-slate: #64748b;
            --light-background: #f8fafc;
            --white: #ffffff;
            --clinic-red: #dc2626;
            --school-blue: #3b82f6;
            --market-green: #059669;
            --homes-orange: #ea580c;
            --success-glow: #10b981;
            --error-glow: #ef4444;
            --primary-glow: #3b82f6;
            --gold: #fbbf24;
            --purple: #8b5cf6;
            --pink: #ec4899;
            /* HUD theme */
            --hud-bg: #0b1220;
            --hud-panel: #0f172a;
            --hud-line: #1f2937;
            --hud-accent: #22d3ee;
            --hud-accent-2: #a78bfa;
            --hud-text: #0f172a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--hud-text);
            background: radial-gradient(1200px circle at 20% -10%, #0f172a 0%, var(--hud-bg) 45%, #050a14 100%);
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: none;
        }
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(800px circle at 80% 20%, rgba(34,211,238,0.08), transparent 60%),
                        radial-gradient(600px circle at 10% 80%, rgba(167,139,250,0.08), transparent 60%);
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Language Toggle */
        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 7000;
            display: flex;
            background: #f8fafc;
            border-radius: 12px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }

        .lang-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            color: var(--neutral-slate);
        }

        .lang-btn.active {
            background: var(--hero-blue);
            color: white;
        }

        .lang-btn:hover:not(.active) {
            background: var(--light-background);
        }

        .lang-btn.reset-btn {
            background: var(--warning-amber);
            color: white;
            margin-left: 0.5rem;
        }

        .lang-btn.reset-btn:hover {
            background: #d97706;
        }

        /* Hindi Text Styling */
        .hindi-text {
            font-family: 'Noto Sans Devanagari', sans-serif;
            font-weight: 500;
        }

        /* Hide inactive language content */
        .lang-content {
            display: none;
        }

        .lang-content.active {
            display: block;
        }

        /* Header Styles */
        .game-header {
            background: linear-gradient(180deg, #1e3a8a, #1f2937);
            color: white;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .game-header::before {
            content: none;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .game-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #fff, #f0f9ff, #e0f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 2s ease-in-out infinite alternate;
            position: relative;
            z-index: 1;
        }

        @keyframes titleGlow {
            0% { filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); }
            100% { filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)); }
        }

        .game-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Stats Bar */
        .stats-container {
            background: white;
            padding: 1rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-grid {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 0 2rem;
        }

        .stat-card {
            background: var(--light-background);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--hero-blue);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--hero-blue);
            font-family: 'Fredoka', sans-serif;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #334155;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        /* Village Map */
        .village-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .village-map {
            position: relative;
            z-index: 1;
            border-radius: 24px;
            padding: 0;
            min-height: 600px;
            box-shadow: 0 14px 36px rgba(0, 0, 0, 0.2);
            border: 1px solid #bfdbfe;
            overflow: hidden;
            background: linear-gradient(180deg, #89d8ff 0%, #a8ecff 40%, #dff9ff 100%);
        }
        /* 3D map canvas container */
        #three-map { position: absolute; inset: 0; z-index: 1; }
        /* Keep background layers below the WebGL canvas */
        .village-map::before, .village-map::after { z-index: 0; }
        /* Always remove 2D overlays in favor of 3D map */
        .village-map .ambient, .village-map .location { display: none !important; }

        .village-map::before { content: none; }

        .village-map::after { content: none; }

        /* Immersive ambient elements inside map */
        .village-map .ambient {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        .village-map .sun {
            position: absolute;
            top: 5%;
            right: 8%;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 40% 40%, #fff7c2 0%, #fde68a 40%, rgba(253,224,71,0.6) 70%, rgba(253,224,71,0) 75%);
            box-shadow: 0 0 60px rgba(253,224,71,0.6);
            filter: blur(0.2px);
            animation: sunPulse 6s ease-in-out infinite;
        }
        @keyframes sunPulse {
            0%,100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        /* Vector clouds via inline SVG for smooth, rounded shapes */
        .cloud-svg { position: absolute; left: -30%; width: 240px; height: 120px; opacity: .85; filter: drop-shadow(0 8px 12px rgba(0,0,0,.08)); }
        .cloud-svg.c1 { top: 12%; animation: cloudDriftSvg 48s linear infinite; }
        .cloud-svg.c2 { top: 24%; transform: scale(1.2); animation: cloudDriftSvg 60s linear infinite; opacity: .8; }
        .cloud-svg.c3 { top: 36%; transform: scale(0.9); animation: cloudDriftSvg 70s linear infinite; opacity: .9; }
        @keyframes cloudDriftSvg { from { transform: translateX(0) scale(var(--s,1)); } to { transform: translateX(160%) scale(var(--s,1)); } }
        .village-map .firefly {
            position: absolute;
            width: 6px; height: 6px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,200,1) 0%, rgba(255,255,200,0.4) 60%, rgba(255,255,200,0) 70%);
            opacity: 0.8;
            animation: fly 9s ease-in-out infinite;
            mix-blend-mode: screen;
        }
        .village-map .firefly.f1 { top: 60%; left: 15%; animation-delay: 0s; }
        .village-map .firefly.f2 { top: 30%; left: 45%; animation-delay: 1s; }
        .village-map .firefly.f3 { top: 70%; left: 75%; animation-delay: 2s; }
        .village-map .firefly.f4 { top: 50%; left: 25%; animation-delay: 3s; }
        @keyframes fly {
            0% { transform: translate(0, 0); opacity: .6; }
            25% { transform: translate(20px, -10px); opacity: .9; }
            50% { transform: translate(-10px, 10px); opacity: .7; }
            75% { transform: translate(15px, -5px); opacity: .9; }
            100% { transform: translate(0, 0); opacity: .6; }
        }

        @keyframes mapPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .map-title {
            text-align: center;
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 2rem;
            font-family: 'Fredoka', sans-serif;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        .location {
            position: absolute;
            z-index: 2;
            pointer-events: auto;
            width: 140px;
            height: 140px;
            border-radius: 30px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 4px solid white;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(255, 255, 255, 0.8),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1);
            position: absolute;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .location::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: left 0.6s;
        }

        .location:hover::before {
            left: 100%;
        }

        .location::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--gold), var(--victory-green), var(--hero-blue), var(--pink));
            border-radius: 32px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .location:hover::after {
            opacity: 1;
        }

        .location:hover {
            transform: translateY(-12px) scale(1.1) rotateY(5deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--gold);
        }

        .location:active {
            transform: translateY(-6px) scale(1.05);
        }

        .location.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .location.completed {
            border-color: var(--victory-green);
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        }

        .location.completed::after {
            content: "✓";
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--victory-green);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.1rem;
            border: 3px solid white;
        }

        .location-icon {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            transition: all 0.3s ease;
            animation: iconFloat 4s ease-in-out infinite;
            position: relative;
        }

        .location:hover .location-icon {
            transform: scale(1.3) rotate(15deg);
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.4));
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-2px) rotate(1deg); }
            50% { transform: translateY(-4px) rotate(0deg); }
            75% { transform: translateY(-2px) rotate(-1deg); }
        }

        .location-name {
            font-weight: 700;
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.2;
        }

        .priority-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: var(--danger-red);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1rem;
            border: 3px solid white;
        }

        /* Location positioning - place in all four corners */
        .clinic { top: 12%; left: 12%; }
        .clinic .location-icon { color: var(--clinic-red); }

        .school { top: 12%; right: 12%; }
        .school .location-icon { color: var(--school-blue); }

        .market { bottom: 12%; left: 12%; }
        .market .location-icon { color: var(--market-green); }

        .homes { bottom: 12%; right: 12%; }
        .homes .location-icon { color: var(--homes-orange); }

        /* Mission Panel */
        .mission-panel {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            height: fit-content;
            border: 2px solid var(--hero-blue);
            color: #0f172a;
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--hero-blue);
            text-align: center;
            font-family: 'Fredoka', sans-serif;
        }

        .emergency-alert {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border: 2px solid var(--danger-red);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: #0f172a;
        }

        .alert-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-title {
            font-weight: 700;
            color: var(--danger-red);
            font-size: 1.1rem;
        }

        .current-mission {
            background: var(--light-background);
            border-radius: 12px;
            padding: 1.5rem;
            color: #0f172a;
        }

        .mission-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .mission-title {
            font-weight: 700;
            color: var(--hero-blue);
            font-size: 1.1rem;
        }

        /* Modal System */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            max-width: 900px;
            width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-background);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--hero-blue);
            font-family: 'Fredoka', sans-serif;
        }

        .close-btn {
            background: var(--danger-red);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            transform: scale(1.1);
        }

        /* Mission Content */
        .mission-intro {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            position: relative;
            overflow: hidden;
            box-shadow: none;
            color: #111827;
        }
        /* remove decorative patterns */

        .npc-dialogue {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .npc-avatar {
            width: 80px;
            height: 80px;
            background: var(--hero-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            flex-shrink: 0;
        }

        .dialogue-bubble {
            background: #ffffff;
            border-radius: 16px;
            padding: 1.5rem;
            flex: 1;
            border: 1px solid #e5e7eb;
            position: relative;
            color: #111827;
        }

        .dialogue-bubble::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 30px;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-right: 12px solid white;
            border-bottom: 10px solid transparent;
        }

        .npc-name {
            font-weight: 700;
            color: var(--hero-blue);
            margin-bottom: 0.5rem;
        }

        /* Challenge Section */
        .challenge-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.25rem;
            margin: 1.25rem 0;
            position: relative;
            overflow: hidden;
            box-shadow: none;
            color: #111827;
        }

        .challenge-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--hero-blue);
            margin-bottom: 1rem;
            text-align: center;
            font-family: 'Fredoka', sans-serif;
        }

        .challenge-description {
            color: var(--neutral-slate);
            margin-bottom: 2rem;
            text-align: center;
            line-height: 1.6;
        }

        /* Market Catch Game */
        .market-game {
            position: relative;
            height: 360px;
            border: 2px dashed var(--market-green);
            border-radius: 16px;
            background: linear-gradient(180deg, #f0fdf4, #ecfeff);
            overflow: hidden;
        }
        .hud {
            display: flex; gap: 1rem; justify-content: center; align-items: center;
            margin-bottom: 1rem; font-weight: 700; color: #065f46;
        }
        .hud .pill { background:#e0f2fe; border:2px solid #93c5fd; border-radius:999px; padding:.35rem .75rem; color:#1e3a8a; }
        .mosquito { position:absolute; width:40px; height:40px; font-size:28px; cursor:pointer; user-select:none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            animation: buzz 1s ease-in-out infinite alternate; }
        @keyframes buzz { 0%{ transform: translate(0,0) rotate(0deg) } 100%{ transform: translate(6px,-6px) rotate(5deg) } }

        @media (max-width: 640px) {
            .market-game { height: 300px; }
            .mosquito { width: 48px; height: 48px; font-size: 34px; }
            .hud { flex-wrap: wrap; gap: .5rem; }
            .option-card { padding: 1rem; }
        }

        /* Swatter cursor for Market game */
        .market-game { cursor: crosshair; }
        .swatter {
            position: absolute;
            width: 64px;
            height: 64px;
            pointer-events: none;
            transform-origin: 50% 50%;
            z-index: 5;
        }
        .swatter.swat { animation: swatPop 160ms ease-out; }
        @keyframes swatPop { from { transform: scale(1.2); opacity: 0.85; } to { transform: scale(1); opacity: 0; } }

        /* Hover tooltips for breeding sites and locations */
        .breeding-site[data-tip]:hover::after, .location[data-tip]:hover::after {
            content: attr(data-tip);
            position: absolute;
            left: 50%;
            bottom: 72px;
            transform: translateX(-50%);
            background: #111827;
            color: #fff;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        .breeding-site[data-tip]:hover::before, .location[data-tip]:hover::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 66px;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #111827;
            z-index: 10;
            pointer-events: none;
        }

        /* Fit stacked tires icon */
        .breeding-site.tires { font-size: 1.6rem; }

        /* Fun ambient mosquitoes around dashboard */
        .mosquito-fly { position:absolute; font-size:24px; opacity:.8; pointer-events:none; z-index: 10; }
        .mosq-a { animation: flyA 14s linear infinite; top: 80px; left: 10%; }
        .mosq-b { animation: flyB 18s linear infinite; top: 120px; right: 12%; }
        .mosq-c { animation: flyC 16s linear infinite; top: 180px; left: 30%; }
        @keyframes flyA { 0%{transform:translateX(0) rotate(0)} 50%{transform:translateX(50vw) rotate(10deg)} 100%{transform:translateX(0) rotate(-5deg)} }
        @keyframes flyB { 0%{transform:translateX(0) rotate(0)} 50%{transform:translateX(-40vw) rotate(-8deg)} 100%{transform:translateX(0) rotate(6deg)} }
        @keyframes flyC { 0%{transform:translateX(0) rotate(0)} 50%{transform:translateX(35vw) rotate(6deg)} 100%{transform:translateX(0) rotate(-6deg)} }

.gutter-icon { width:34px; height:34px; }

        /* Option Grids */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .option-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.9rem;
            color: #111827;
        }

        .option-card:hover {
            background: #f9fafb;
        }

        .option-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .option-card.correct {
            border-color: #16a34a;
            background: #f0fdf4;
        }

        .option-card.incorrect {
            border-color: #dc2626;
            background: #fef2f2;
        }

        /* Unselected but correct answer (shown after submission) */
        .option-card.missed {
            border-color: #16a34a;
            border-style: dashed;
            background: #f0fdf4;
            position: relative;
        }
        .option-card.missed::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 10px;
            color: var(--victory-green);
            font-weight: 800;
        }

        .option-icon {
            font-size: 1.25rem;
            margin: 0;
            filter: none;
        }

        .option-name {
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            color: #111827;
            font-size: 0.98rem;
            letter-spacing: 0;
        }

        /* Big clinical symptom cards */
        .option-card[data-symptom] { flex-direction: column; align-items: center; text-align: center; padding: 1.5rem; min-height: 160px; }
        .option-card[data-symptom] .option-icon { font-size: 2.2rem; margin-bottom: 0.75rem; }
        .option-card[data-symptom] .option-name { font-size: 1.05rem; }

        /* Student Grid for School */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .student-card {
            background: white;
            border: 2px solid var(--light-background);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .student-card.protected {
            border-color: var(--hero-blue);
            background: linear-gradient(135deg, #eef2ff, #dbeafe);
        }

        /* Neutralize risk color coding to avoid confusion */
        .student-card.high-risk,
        .student-card.medium-risk,
        .student-card.low-risk {
            border-color: var(--light-background);
        }

        .bed-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .student-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .student-age {
            font-size: 0.85rem;
            color: var(--neutral-slate);
        }

        /* Compound Map for Homes */
        .compound-container {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 20px;
            padding: 1rem;
            margin: 2rem 0;
            position: relative;
            min-height: 450px;
            width: 100%;
            border: 3px solid var(--warning-amber);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 20px, transparent 20px),
                radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.1) 15px, transparent 15px),
                radial-gradient(circle at 60% 70%, rgba(245, 158, 11, 0.1) 25px, transparent 25px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        /* Subtle water shimmer overlay */
        .compound-container::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(115deg, rgba(255,255,255,0.0) 40%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.0) 60%);
            opacity: 0.5;
            animation: waterShimmer 6s linear infinite;
            pointer-events: none;
        }
        @keyframes waterShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .compound-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .compound-title {
            text-align: center;
            font-weight: 700;
            color: var(--homes-orange);
            margin-bottom: 1rem;
            font-size: 1.3rem;
            position: relative;
            z-index: 2;
        }

        .breeding-progress {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1.5rem 0;
            border: 2px solid var(--warning-amber);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .breeding-progress:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .progress-item {
            text-align: center;
        }

        .progress-number {
            font-size: 1.8rem;
            font-weight: 800;
            display: block;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .progress-number:hover {
            transform: scale(1.1);
        }

        .progress-number.found { color: var(--victory-green); }
        .progress-number.attempts { color: var(--danger-red); }
        .progress-number.target { color: var(--warning-amber); }
        .progress-number.score { color: var(--hero-blue); }

        .progress-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--neutral-slate);
        }

        .breeding-site {
            position: absolute;
            width: 60px;
            height: 60px;
            cursor: help;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            border: 2px solid var(--light-background);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(15px);
            overflow: hidden;
            z-index: 3;
        }

        .breeding-site::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            transition: left 0.5s;
        }

        .breeding-site:hover::before {
            left: 100%;
        }

        .breeding-site:hover {
            transform: scale(1.2) rotateY(5deg);
            border-color: var(--gold);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(248, 250, 252, 1) 100%);
        }

        .breeding-site.correct {
            border-color: var(--victory-green);
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            animation: correctPulse 1s ease-out;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        .breeding-site.correct::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            border: 2px solid rgba(16,185,129,.45);
            animation: ripple 1.2s ease-out 2;
        }

        @keyframes ripple {
            from { transform: scale(1); opacity: 0.8; }
            to { transform: scale(1.6); opacity: 0; }
        }

        .breeding-site.incorrect {
            border-color: var(--danger-red);
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            animation: incorrectShake 0.6s ease-out;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
        /* Hint pulse for remaining correct sites */
        .breeding-site.hint {
            animation: hintPulse 1.2s ease-in-out infinite;
        }
        @keyframes hintPulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(59,130,246,0.0); }
            50% { box-shadow: 0 0 0 8px rgba(59,130,246,0.15); }
        }

        @keyframes correctPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            70% { transform: scale(1.2); box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
            100% { transform: scale(1.15); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Breeding site positions using percentages - all visible in the compound */
        .site-1  { top: 15%; left: 10%; }
        .site-2  { top: 15%; left: 30%; }
        .site-3  { top: 15%; left: 50%; }
        .site-4  { top: 15%; left: 70%; }

        .site-5  { top: 45%; left: 15%; }
        .site-6  { top: 45%; left: 35%; }
        .site-7  { top: 45%; left: 55%; }
        .site-8  { top: 45%; left: 75%; }

        .site-9  { top: 75%; left: 10%; }
        .site-10 { top: 75%; left: 30%; }
        .site-11 { top: 75%; left: 50%; }
        .site-12 { top: 75%; left: 70%; }

        /* Particle effects */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--gold);
            border-radius: 50%;
            pointer-events: none;
            animation: particleFloat 2s ease-out forwards;
        }

        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0);
            }
        }

        /* Celebration animation */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--gold);
            animation: confettiFall 3s linear forwards;
        }

        .confetti:nth-child(odd) {
            background: var(--victory-green);
        }

        .confetti:nth-child(3n) {
            background: var(--hero-blue);
        }

        .confetti:nth-child(4n) {
            background: var(--pink);
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Help Panel */
        .help-panel {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 2px solid var(--hero-blue);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 2rem 0;
            display: none;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
            transition: all 0.3s ease;
        }

        .help-panel.show {
            display: block;
            animation: slideDown 0.5s ease;
            box-shadow: 0 12px 35px rgba(37, 99, 235, 0.25);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .help-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--hero-blue);
            margin-bottom: 1rem;
        }

        /* Action Buttons */
        .action-btn {
            background: linear-gradient(180deg, #16a34a, #15803d);
            color: white;
            border: 1px solid #166534;
            padding: 0.9rem 1.4rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.05s ease;
            display: inline-block;
            margin: 1rem auto;
            box-shadow: 0 8px 18px rgba(0,0,0,0.35);
            font-family: 'Rajdhani', 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn:hover {
            background: linear-gradient(180deg, #17a84b, #127a36);
            transform: translateY(-1px);
        }
        .action-btn:active { transform: translateY(0); }

        .action-btn:disabled {
            background: var(--neutral-slate);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Feedback Panels */
        .feedback-panel {
            background: var(--light-background);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            display: none;
        }

        .feedback-panel.show {
            display: block;
            animation: slideDown 0.5s ease;
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .feedback-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .feedback-icon.success {
            background: var(--victory-green);
            color: white;
        }

        .feedback-icon.warning {
            background: var(--warning-amber);
            color: white;
        }

        .feedback-icon.error {
            background: var(--danger-red);
            color: white;
        }

        .feedback-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .feedback-title.success { color: var(--victory-green); }
        .feedback-title.warning { color: var(--warning-amber); }
        .feedback-title.error { color: var(--danger-red); }

        /* Completion Modal */
        .completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            pointer-events: none;
        }

        .completion-modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .completion-content {
            background: white;
            border-radius: 24px;
            padding: 3rem;
            max-width: 800px;
            width: 95vw;
            text-align: center;
            transform: scale(0.8);
            transition: all 0.5s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .completion-modal.active .completion-content {
            transform: scale(1);
        }

        .completion-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--victory-green);
            margin-bottom: 1rem;
            font-family: 'Fredoka', sans-serif;
        }

        .completion-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .completion-stat {
            background: var(--light-background);
            border-radius: 16px;
            padding: 2rem;
        }

        .completion-number {
            font-size: 3rem;
            font-weight: 800;
            color: var(--hero-blue);
            font-family: 'Fredoka', sans-serif;
        }

        .completion-label {
            font-weight: 600;
            color: var(--neutral-slate);
        }

        /* Certificate Styles */
        .certificate-modal {
            z-index: 3000;
        }

        .certificate-container {
            border: 4px solid var(--hero-blue);
            border-radius: 16px;
            padding: 2rem;
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            position: relative;
            min-height: 400px;
            color: #0f172a;
        }

        .certificate-decorations {
            position: absolute;
            font-size: 2rem;
        }

        .cert-trophy { top: 10px; right: 10px; }
        .cert-globe { top: 10px; left: 10px; }
        .cert-mosquito { bottom: 10px; right: 10px; }
        .cert-medical { bottom: 10px; left: 10px; }

        .certificate-title {
            color: var(--hero-blue);
            font-size: 2.5rem;
            margin: 1rem 0;
            font-family: 'Fredoka', sans-serif;
        }

        .certificate-subtitle {
            color: var(--victory-green);
            font-family: 'Quicksand', sans-serif;
            margin: 1rem 0;
            font-size: 1.5rem;
        }

        .certificate-name {
            color: var(--hero-blue);
            font-size: 2rem;
            margin: 1rem 0;
            border-bottom: 2px solid var(--hero-blue);
            display: inline-block;
            padding: 0.5rem 1rem;
            min-width: 300px;
        }

        .certificate-stats {
            display: flex;
            justify-content: space-around;
            margin: 2rem 0;
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 12px;
        }

        .cert-stat {
            text-align: center;
        }

        .cert-stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }

        .cert-stat-number.lives { color: var(--victory-green); }
        .cert-stat-number.points { color: var(--hero-blue); }
        .cert-stat-number.success { color: var(--warning-amber); }

        .cert-stat-label {
            font-size: 0.9rem;
            color: var(--neutral-slate);
        }

        .certificate-footer {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: var(--neutral-slate);
        }

        .certificate-signature {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        .signature-line {
            border-top: 2px solid var(--hero-blue);
            width: 200px;
            text-align: center;
            padding-top: 0.5rem;
        }

        .signature-title {
            font-size: 0.8rem;
            color: var(--neutral-slate);
        }

        .name-input {
            padding: 0.75rem 1rem;
            border: 2px solid var(--hero-blue);
            border-radius: 8px;
            font-size: 1rem;
            width: 300px;
            text-align: center;
            margin: 1rem 0;
        }

        .cert-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .cert-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cert-btn.generate {
            background: var(--hero-blue);
            color: white;
        }

        .cert-btn.download {
            background: var(--victory-green);
            color: white;
        }

        .cert-btn.close {
            background: var(--neutral-slate);
            color: white;
        }

        .cert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Tutorial System */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .tutorial-overlay.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .tutorial-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90vw;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
            position: relative;
        }

        .tutorial-overlay.active .tutorial-card {
            transform: scale(1);
        }

        .tutorial-mascot {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: mascotBounce 2s ease-in-out infinite;
        }

        @keyframes mascotBounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .tutorial-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--hero-blue);
            margin-bottom: 1rem;
            font-family: 'Fredoka', sans-serif;
        }

        .tutorial-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #374151;
            margin-bottom: 2rem;
        }

        .tutorial-progress {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            transition: background 0.3s ease;
        }

        .progress-dot.active {
            background: var(--hero-blue);
        }

        .tutorial-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tutorial-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tutorial-btn.primary {
            background: var(--hero-blue);
            color: white;
        }

        .tutorial-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .badges-shelf { max-width: 1200px; margin: 1rem auto; padding: 0 2rem; }
        .badges-title { color: var(--hero-blue); font-family: 'Fredoka', sans-serif; margin-bottom: .5rem; }
        .badges-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: .75rem; }
        .badge-card { background: #ffffff; border: 2px solid #e5e7eb; border-radius: 12px; padding: .75rem; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .badge-icon { font-size: 1.8rem; display: block; margin-bottom: .25rem; }
        .badge-name { font-weight: 700; font-size: .95rem; }
        .badge-desc { color: #6b7280; font-size: .8rem; margin-top: .25rem; }

        .tutorial-highlight {
            position: absolute;
            border: 3px solid var(--gold);
            border-radius: 12px;
            background: rgba(251, 191, 36, 0.1);
            pointer-events: none;
            animation: highlightPulse 2s ease-in-out infinite;
        }

        @keyframes highlightPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
        }

        .help-icon {
            position: fixed;
            top: 20px;
            right: 80px;
            width: 50px;
            height: 50px;
            background: var(--hero-blue);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 6000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        /* SFX toggle */
        .sfx-toggle {
            position: fixed;
            top: 20px;
            right: 140px;
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            background: #111827;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 6000;
            transition: transform .2s ease, box-shadow .2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }
        .sfx-toggle:hover { transform: scale(1.06); }

        /* Fun fact button */
        .funfact-icon {
            position: fixed;
            top: 80px;
            right: 140px;
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            background: #f59e0b;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 6000;
            transition: transform .2s ease, box-shadow .2s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }
        .funfact-icon:hover { transform: scale(1.06); }

        .help-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        /* Learn More cards */
        .learn-more {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 0.875rem 1rem;
            margin-top: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: none;
            color: #111827;
        }
        .learn-more h4 { color: var(--hero-blue); margin-bottom: .5rem; font-size: 1.05rem; }
        .learn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .5rem; }
        .resource-link { display: block; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; padding: .6rem .8rem; text-decoration: none; color: #111827; font-weight: 600; }
        .resource-link:hover { border-color: #2563eb; background: #f9fafb; }
        .resource-link:hover { border-color: var(--hero-blue); box-shadow: 0 4px 12px rgba(37,99,235,0.15); }

        /* Expandable Feedback Sections */
        .expandable-section {
            margin: 1rem 0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .expandable-header {
            background: linear-gradient(135deg, #f0f9ff, #dbeafe);
            padding: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .expandable-header:hover {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        }

        .expandable-title {
            font-weight: 600;
            color: var(--hero-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
        }

        .expandable-header.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: white;
            border-radius: 0 0 12px 12px;
        }

        .expandable-content.expanded {
            max-height: 500px;
        }

        .expandable-body {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .fact-box {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left: 4px solid var(--victory-green);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
        }

        .fact-box h4 {
            color: var(--victory-green);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .stat-highlight {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid var(--warning-amber);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
        }

        .stat-highlight h4 {
            color: var(--warning-amber);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .real-world-example {
            background: linear-gradient(135deg, #f0f9ff, #dbeafe);
            border-left: 4px solid var(--hero-blue);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
        }

        .real-world-example h4 {
            color: var(--hero-blue);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        /* Glossary System */
        .glossary-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2500;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .glossary-overlay.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .glossary-panel {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .glossary-overlay.active .glossary-panel {
            transform: scale(1);
        }

        .glossary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .glossary-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--hero-blue);
            font-family: 'Fredoka', sans-serif;
        }

        .glossary-search {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s ease;
        }

        .glossary-search:focus {
            outline: none;
            border-color: var(--hero-blue);
        }

        .glossary-term {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid var(--hero-blue);
        }

        .term-title {
            font-weight: 700;
            color: var(--hero-blue);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .term-simple {
            color: #374151;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .term-medical {
            color: #6b7280;
            font-size: 0.9rem;
            font-style: italic;
        }

        .glossary-icon {
            position: fixed;
            top: 80px;
            right: 80px;
            width: 50px;
            height: 50px;
            background: var(--victory-green);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 6000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .glossary-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        @media (max-width: 768px) {
            .village-container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }

            .village-map {
                min-height: 400px;
            }

            .location {
                width: 100px;
                height: 100px;
            }

            /* Mobile location positioning */
            .clinic { top: 10%; left: 8%; }
            .school { top: 10%; right: 8%; }
            .market { bottom: 10%; left: 8%; }
            .homes { bottom: 10%; right: 8%; }

            .location-icon {
                font-size: 2.5rem;
            }

            .breeding-site {
                width: 50px;
                height: 50px;
                font-size: 1.8rem;
            }

            .compound-container {
                min-height: 380px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .student-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .cert-buttons {
                flex-direction: column;
                align-items: center;
            }

            .certificate-name {
                font-size: 1.5rem;
                min-width: 250px;
            }

            .certificate-stats {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Language Toggle -->
    <div class="language-toggle">
        <button class="lang-btn active" onclick="switchLanguage('en')" data-lang="en">🇬🇧 English</button>
        <button class="lang-btn" onclick="switchLanguage('hi')" data-lang="hi">🇮🇳 हिन्दी</button>
        <button class="lang-btn reset-btn" onclick="resetGame()" title="Reset Game">🔄 Reset</button>
    </div>

    <!-- Help Icon -->
    <button class="help-icon" onclick="startTutorial()" title="Help & Tutorial">?</button>

    <!-- SFX Toggle -->
    <button class="sfx-toggle" onclick="toggleSfx()" title="Sound Effects">🔊</button>

    <!-- Glossary Icon -->
    <button class="glossary-icon" onclick="openGlossary()" title="Health Word List">📖</button>

    <!-- Fun Fact -->
    <button class="funfact-icon" onclick="showFunFact()" title="Malaria Fun Fact">💡</button>

    <!-- Game Header -->
    <header class="game-header">
        <!-- English Header -->
        <div class="lang-content active" data-lang="en">
            <h1 class="game-title">🌍 Malaria Heroes</h1>
            <p class="game-subtitle">Emergency Response Training • Save Nyanja Village</p>
        </div>
        <!-- Hindi Header -->
        <div class="lang-content hindi-text" data-lang="hi">
            <h1 class="game-title">🌍 मलेरिया वीर</h1>
            <p class="game-subtitle">आपातकालीन प्रतिक्रिया प्रशिक्षण • न्यांजा गांव को बचाएं</p>
        </div>
    </header>

    <!-- Stats Container -->
    <div class="stats-container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="livesProtected">0</div>
                <!-- English -->
                <div class="stat-label lang-content active" data-lang="en">Lives Protected</div>
                <!-- Hindi -->
                <div class="stat-label lang-content hindi-text" data-lang="hi">संरक्षित जीवन</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="knowledgePoints">0</div>
                <!-- English -->
                <div class="stat-label lang-content active" data-lang="en">Knowledge Points</div>
                <!-- Hindi -->
                <div class="stat-label lang-content hindi-text" data-lang="hi">ज्ञान अंक</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="missionsCompleted">0</div>
                <!-- English -->
                <div class="stat-label lang-content active" data-lang="en">Missions Completed</div>
                <!-- Hindi -->
                <div class="stat-label lang-content hindi-text" data-lang="hi">पूर्ण मिशन</div>
            </div>
        </div>
    </div>

    <!-- Badges Shelf -->
    <div class="badges-shelf" id="badges-shelf">
        <h3 class="badges-title lang-content active" data-lang="en">🎖️ Badges</h3>
        <h3 class="badges-title lang-content hindi-text" data-lang="hi">🎖️ बैज</h3>
        <div class="badges-grid" id="badges-grid"></div>
    </div>

    <!-- Village Container -->
    <div class="village-container">
        <!-- Village Map -->
        <div class="village-map">
            <div class="ambient">
                <div class="sun"></div>
                <svg class="cloud-svg c1" viewBox="0 0 240 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <defs>
                    <filter id="blur1" x="-20%" y="-20%" width="140%" height="140%">
                      <feGaussianBlur stdDeviation="3" />
                    </filter>
                  </defs>
                  <path filter="url(#blur1)" fill="#FFFFFF" d="M40,80 C20,80 10,65 20,55 C22,35 45,35 55,45 C60,25 95,20 110,38 C125,25 160,30 165,50 C190,50 200,65 195,78 C190,92 165,95 150,90 C140,97 120,100 100,92 C80,100 55,95 50,88 C45,90 30,90 40,80 Z"/>
                </svg>
                <svg class="cloud-svg c2" viewBox="0 0 240 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <defs>
                    <filter id="blur2" x="-20%" y="-20%" width="140%" height="140%">
                      <feGaussianBlur stdDeviation="2.5" />
                    </filter>
                  </defs>
                  <path filter="url(#blur2)" fill="#FFFFFF" d="M30,75 C10,75 5,60 15,52 C18,35 40,35 50,42 C60,28 88,25 105,40 C118,28 150,32 158,48 C178,48 188,60 184,72 C180,86 158,90 144,86 C134,92 116,94 96,88 C78,94 54,90 48,84 C44,86 26,86 30,75 Z"/>
                </svg>
                <svg class="cloud-svg c3" viewBox="0 0 240 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <defs>
                    <filter id="blur3" x="-20%" y="-20%" width="140%" height="140%">
                      <feGaussianBlur stdDeviation="2.2" />
                    </filter>
                  </defs>
                  <path filter="url(#blur3)" fill="#FFFFFF" d="M36,78 C18,78 12,64 20,56 C24,40 46,40 56,46 C66,30 94,28 112,42 C126,32 154,35 160,50 C176,50 186,62 182,74 C178,86 160,90 148,86 C136,94 118,96 98,90 C80,96 56,92 50,86 C46,88 30,88 36,78 Z"/>
                </svg>
                <div class="firefly f1"></div>
                <div class="firefly f2"></div>
                <div class="firefly f3"></div>
                <div class="firefly f4"></div>
                <!-- Ambient mosquitoes for fun -->
                <div class="mosquito-fly mosq-a">🦟</div>
                <div class="mosquito-fly mosq-b">🦟</div>
                <div class="mosquito-fly mosq-c">🦟</div>
            </div>
            <!-- English Title -->
            <h2 class="map-title lang-content active" data-lang="en">🏘️ Nyanja Village Malaria Response</h2>
            <!-- Hindi Title -->
            <h2 class="map-title lang-content hindi-text" data-lang="hi">🏘️ न्यांजा गांव मलेरिया प्रतिक्रिया</h2>
            
            <!-- Emergency Clinic -->
            <div class="location clinic" id="clinic-location" onclick="openMission('clinic')" data-tip="Clinic - Diagnose malaria symptoms">
                <div class="location-icon">🏥</div>
                <!-- English -->
                <div class="location-name lang-content active" data-lang="en">Emergency<br>Clinic</div>
                <!-- Hindi -->
                <div class="location-name lang-content hindi-text" data-lang="hi">आपातकालीन<br>क्लिनिक</div>
                <div class="priority-badge">1</div>
            </div>
            
            <!-- Village School -->
            <div class="location school disabled" id="school-location" onclick="openMission('school')" data-tip="School - Prioritize bed nets">
                <div class="location-icon">🏫</div>
                <!-- English -->
                <div class="location-name lang-content active" data-lang="en">Village<br>School</div>
                <!-- Hindi -->
                <div class="location-name lang-content hindi-text" data-lang="hi">गांव का<br>विद्यालय</div>
                <div class="priority-badge" style="display: none;">2</div>
            </div>
            
            <!-- Community Market -->
            <div class="location market disabled" id="market-location" onclick="openMission('market')" data-tip="Market - Catch mosquitoes with a net to protect people">
                <div class="location-icon">🏪</div>
                <!-- English -->
                <div class="location-name lang-content active" data-lang="en">Community<br>Market</div>
                <!-- Hindi -->
                <div class="location-name lang-content hindi-text" data-lang="hi">सामुदायिक<br>बाजार</div>
                <div class="priority-badge" style="display: none;">3</div>
            </div>
            
            <!-- Family Homes -->
            <div class="location homes disabled" id="homes-location" onclick="openMission('homes')" data-tip="Homes - Find and remove breeding sites">
                <div class="location-icon">🏠</div>
                <!-- English -->
                <div class="location-name lang-content active" data-lang="en">Family<br>Compounds</div>
                <!-- Hindi -->
                <div class="location-name lang-content hindi-text" data-lang="hi">पारिवारिक<br>परिसर</div>
                <div class="priority-badge" style="display: none;">4</div>
            </div>
        </div>

        <!-- Mission Panel -->
        <div class="mission-panel">
            <!-- English Panel -->
            <div class="lang-content active" data-lang="en">
                <h2 class="panel-title">📋 Mission Control</h2>
                
                <div class="emergency-alert">
                    <div class="alert-header">
                        <span class="alert-icon">🚨</span>
                        <h3 class="alert-title">Critical Health Emergency</h3>
                    </div>
                    <p>A severe malaria outbreak is spreading rapidly through Nyanja Village. Latest WHO 2024 data shows 597,000 malaria deaths globally with 263 million cases. As a medical expert, you must use scientific knowledge and evidence-based strategies to save lives and prevent further transmission.</p>
                </div>
                
                <div class="current-mission">
                    <div class="mission-header">
                        <span class="alert-icon">🎯</span>
                        <h3 class="mission-title">Current Mission</h3>
                    </div>
                    <p id="current-mission-text">Visit the Emergency Clinic where a critically ill 8-year-old patient needs immediate medical diagnosis. Lives depend on your expertise!</p>
                </div>

<div class="learn-more">
                    <h4>📚 Learn more</h4>
<div class="learn-grid">
                        <a class="resource-link" href="https://www.childrenforhealth.org/100messages/malaria/" target="_blank" rel="noopener">Children for Health - Malaria messages</a>
                        <a class="resource-link" href="https://kids.britannica.com/kids/article/malaria/394698" target="_blank" rel="noopener">Kids.Britannica - Malaria</a>
                        <a class="resource-link" href="https://kids.frontiersin.org/articles/10.3389/frym.2024.1305938" target="_blank" rel="noopener">Frontiers for Young Minds - Malaria for kids</a>
                        <a class="resource-link" href="https://targetmalaria.org/why-malaria-matters/educational-material/" target="_blank" rel="noopener">Target Malaria - Educational material</a>
                        <a class="resource-link" href="https://youtu.be/PGiqxnAr2fQ?si=pErVIPNM2bpHesQM" target="_blank" rel="noopener">Video: What causes malaria? (Dr. Binocs)</a>
                        <a class="resource-link" href="https://youtu.be/gwYIyjwYluc?si=cO7828LnBfDOSlj_" target="_blank" rel="noopener">Video: Intro to malaria (key facts)</a>
                        <a class="resource-link" href="https://www.cdc.gov/malaria/about/index.html" target="_blank" rel="noopener">CDC - Malaria (about, symptoms, diagnosis)</a>
                        <a class="resource-link" href="https://www.who.int/news-room/fact-sheets/detail/malaria" target="_blank" rel="noopener">WHO - Malaria fact sheet</a>
                    </div>
                </div>
            </div>

            <!-- Hindi Panel -->
            <div class="lang-content hindi-text" data-lang="hi">
                <h2 class="panel-title">📋 मिशन नियंत्रण</h2>
                
                <div class="emergency-alert">
                    <div class="alert-header">
                        <span class="alert-icon">🚨</span>
                        <h3 class="alert-title">गंभीर स्वास्थ्य आपातकाल</h3>
                    </div>
                    <p>न्यांजा गांव में मलेरिया का गंभीर प्रकोप तेजी से फैल रहा है। नवीनतम WHO 2024 आंकड़े 263 मिलियन मामलों के साथ विश्वव्यापी स्तर पर 597,000 मलेरिया मृत्यु दर्शाते हैं। एक चिकित्सा विशेषज्ञ के रूप में, आपको वैज्ञानिक ज्ञान और साक्ष्य-आधारित रणनीतियों का उपयोग करके जीवन बचाना और आगे के संचरण को रोकना होगा।</p>
                </div>
                
                <div class="current-mission">
                    <div class="mission-header">
                        <span class="alert-icon">🎯</span>
                        <h3 class="mission-title">वर्तमान मिशन</h3>
                    </div>
                    <p id="current-mission-text-hi">आपातकालीन क्लिनिक में जाएं जहां एक गंभीर रूप से बीमार 8 वर्षीय रोगी को तत्काल चिकित्सा निदान की आवश्यकता है। जीवन आपकी विशेषज्ञता पर निर्भर है!</p>
                </div>

<div class="learn-more">
                    <h4>📚 और जानें</h4>
<div class="learn-grid">
                        <a class="resource-link" href="https://www.childrenforhealth.org/100messages/malaria/" target="_blank" rel="noopener">Children for Health - Malaria messages</a>
                        <a class="resource-link" href="https://kids.britannica.com/kids/article/malaria/394698" target="_blank" rel="noopener">Kids.Britannica - Malaria</a>
                        <a class="resource-link" href="https://kids.frontiersin.org/articles/10.3389/frym.2024.1305938" target="_blank" rel="noopener">Frontiers for Young Minds - Malaria</a>
                        <a class="resource-link" href="https://targetmalaria.org/why-malaria-matters/educational-material/" target="_blank" rel="noopener">Target Malaria - Educational material</a>
                        <a class="resource-link" href="https://youtu.be/PGiqxnAr2fQ?si=pErVIPNM2bpHesQM" target="_blank" rel="noopener">Video: What causes malaria? (kids)</a>
                        <a class="resource-link" href="https://youtu.be/gwYIyjwYluc?si=cO7828LnBfDOSlj_" target="_blank" rel="noopener">Video: Malaria intro and key facts</a>
                        <a class="resource-link" href="https://www.cdc.gov/malaria/about/index.html" target="_blank" rel="noopener">CDC - Malaria (about, symptoms, diagnosis)</a>
                        <a class="resource-link" href="https://www.who.int/news-room/fact-sheets/detail/malaria" target="_blank" rel="noopener">WHO - Malaria fact sheet</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mission Modal -->
    <div class="modal" id="mission-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Mission Details</h2>
                <button class="close-btn" onclick="closeMissionModal()">×</button>
            </div>
            <div id="modal-content">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Completion Modal -->
    <div class="completion-modal" id="completion-modal">
        <div class="completion-content" style="position: relative;">
            <button class="close-btn" onclick="closeCompletionModal()" title="Close" style="position:absolute; top: 16px; right: 16px;">×</button>
            <!-- English Completion -->
            <div class="lang-content active" data-lang="en">
                <h2 class="completion-title">🏆 Mission Accomplished!</h2>
                <p>Congratulations! You've successfully helped protect Nyanja Village from malaria using scientific evidence and proven medical strategies.</p>
                
                <div class="completion-stats">
                    <div class="completion-stat">
                        <div class="completion-number" id="final-lives">0</div>
                        <div class="completion-label">Lives Protected</div>
                    </div>
                    <div class="completion-stat">
                        <div class="completion-number" id="final-points">0</div>
                        <div class="completion-label">Knowledge Points</div>
                    </div>
                    <div class="completion-stat">
                        <div class="completion-number">100%</div>
                        <div class="completion-label">Village Protected</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="action-btn" onclick="showCertificateModal()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        🎓 Get Certificate
                    </button>
                    <button class="action-btn" onclick="restartGame()">🎮 Play Again</button>
                </div>
            </div>

            <!-- Hindi Completion -->
            <div class="lang-content hindi-text" data-lang="hi">
                <h2 class="completion-title">🏆 मिशन पूर्ण!</h2>
                <p>बधाई हो! आपने वैज्ञानिक साक्ष्य और सिद्ध चिकित्सा रणनीतियों का उपयोग करके न्यांजा गांव को मलेरिया से बचाने में सफलतापूर्वक सहायता की है।</p>
                
                <div class="completion-stats">
                    <div class="completion-stat">
                        <div class="completion-number" id="final-lives-hi">0</div>
                        <div class="completion-label">संरक्षित जीवन</div>
                    </div>
                    <div class="completion-stat">
                        <div class="completion-number" id="final-points-hi">0</div>
                        <div class="completion-label">ज्ञान अंक</div>
                    </div>
                    <div class="completion-stat">
                        <div class="completion-number">100%</div>
                        <div class="completion-label">सुरक्षित गांव</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="action-btn" onclick="showCertificateModal()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        🎓 प्रमाणपत्र प्राप्त करें
                    </button>
                    <button class="action-btn" onclick="restartGame()">🎮 फिर से खेलें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Glossary Modal -->
    <div class="glossary-overlay" id="glossary-overlay">
        <div class="glossary-panel">
            <div class="glossary-header">
                <h2 class="glossary-title">📖 Hero’s Health Word List</h2>
                <button onclick="closeGlossary()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
            </div>
            <input type="text" class="glossary-search" id="glossary-search" placeholder="Search health words...">
            <div id="glossary-content">
                <!-- Terms will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="tutorial-overlay" id="tutorial-overlay">
        <div class="tutorial-card">
            <div class="tutorial-mascot" id="tutorial-mascot">🦟</div>
            <h2 class="tutorial-title" id="tutorial-title">Welcome to Malaria Heroes!</h2>
            <div class="tutorial-content" id="tutorial-content">
                You're about to become a malaria prevention expert! This game will teach you how to save lives using real WHO guidelines and scientific evidence.
            </div>
            <div class="tutorial-progress">
                <div class="progress-dot active" id="progress-1"></div>
                <div class="progress-dot" id="progress-2"></div>
                <div class="progress-dot" id="progress-3"></div>
                <div class="progress-dot" id="progress-4"></div>
                <div class="progress-dot" id="progress-5"></div>
            </div>
            <div class="tutorial-buttons">
                <button class="tutorial-btn secondary" onclick="skipTutorial()">Skip Tutorial</button>
                <button class="tutorial-btn primary" onclick="nextTutorialStep()" id="tutorial-next">Let's Start!</button>
            </div>
        </div>
    </div>

    <!-- Certificate Modal -->
    <div class="modal certificate-modal" id="certificate-modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; text-align: center;">
            <div class="certificate-container" id="certificate-container">
                <div class="certificate-decorations cert-trophy">🏆</div>
                <div class="certificate-decorations cert-globe">🌍</div>
                <div class="certificate-decorations cert-mosquito">🦟</div>
                <div class="certificate-decorations cert-medical">🩺</div>
                
                <!-- English Certificate -->
                <div class="lang-content active" data-lang="en">
                    <h1 class="certificate-title">Certificate of Achievement</h1>
                    <h2 class="certificate-subtitle">Malaria Heroes Training Program</h2>
                    
                    <div style="margin: 2rem 0; font-size: 1.2rem;">
                        <p style="margin: 0.5rem 0;">This certifies that</p>
                        <div class="certificate-name" id="certificate-name">Player Name</div>
                        <p style="margin: 0.5rem 0;">has successfully completed the Malaria Heroes emergency response training</p>
                    </div>
                </div>

                <!-- Hindi Certificate -->
                <div class="lang-content hindi-text" data-lang="hi">
                    <h1 class="certificate-title">उपलब्धि प्रमाणपत्र</h1>
                    <h2 class="certificate-subtitle">मलेरिया वीर प्रशिक्षण कार्यक्रम</h2>
                    
                    <div style="margin: 2rem 0; font-size: 1.2rem;">
                        <p style="margin: 0.5rem 0;">यह प्रमाणित करता है कि</p>
                        <div class="certificate-name" id="certificate-name-hi">खिलाड़ी का नाम</div>
                        <p style="margin: 0.5rem 0;">ने सफलतापूर्वक मलेरिया वीर आपातकालीन प्रतिक्रिया प्रशिक्षण पूरा किया है</p>
                    </div>
                </div>
                
                <div class="certificate-stats">
                    <div class="cert-stat">
                        <span class="cert-stat-number lives" id="certificate-lives">0</span>
                        <!-- English -->
                        <div class="cert-stat-label lang-content active" data-lang="en">Lives Protected</div>
                        <!-- Hindi -->
                        <div class="cert-stat-label lang-content hindi-text" data-lang="hi">संरक्षित जीवन</div>
                    </div>
                    <div class="cert-stat">
                        <span class="cert-stat-number points" id="certificate-points">0</span>
                        <!-- English -->
                        <div class="cert-stat-label lang-content active" data-lang="en">Knowledge Points</div>
                        <!-- Hindi -->
                        <div class="cert-stat-label lang-content hindi-text" data-lang="hi">ज्ञान अंक</div>
                    </div>
                    <div class="cert-stat">
                        <span class="cert-stat-number success">100%</span>
                        <!-- English -->
                        <div class="cert-stat-label lang-content active" data-lang="en">Mission Success</div>
                        <!-- Hindi -->
                        <div class="cert-stat-label lang-content hindi-text" data-lang="hi">मिशन सफलता</div>
                    </div>
                </div>
                
                <div class="certificate-footer">
                    <!-- English -->
                    <div class="lang-content active" data-lang="en">
                        <p>Issued on <span id="certificate-date"></span></p>
                        <p style="margin-top: 0.5rem;">WHO Malaria Prevention Guidelines • Evidence-Based Training</p>
                    </div>
                    <!-- Hindi -->
                    <div class="lang-content hindi-text" data-lang="hi">
                        <p>जारी करने की तिथि <span id="certificate-date-hi"></span></p>
                        <p style="margin-top: 0.5rem;">WHO मलेरिया रोकथाम दिशानिर्देश • साक्ष्य-आधारित प्रशिक्षण</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 2rem;">
                <!-- English -->
                <input type="text" id="player-name-input" class="name-input lang-content active" data-lang="en" placeholder="Enter your name">
                <!-- Hindi -->
                <input type="text" id="player-name-input-hi" class="name-input lang-content hindi-text" data-lang="hi" placeholder="अपना नाम लिखें">
            </div>
            
            <div class="cert-buttons">
                <!-- English -->
                <div class="lang-content active" data-lang="en">
                    <button onclick="generateCertificate()" class="cert-btn generate">Generate Certificate</button>
                    <button onclick="downloadCertificate()" class="cert-btn download">Download PNG</button>
                    <button onclick="closeCertificateModal()" class="cert-btn close">Close</button>
                </div>
                <!-- Hindi -->
                <div class="lang-content hindi-text" data-lang="hi">
                    <button onclick="generateCertificate()" class="cert-btn generate">प्रमाणपत्र बनाएं</button>
                    <button onclick="downloadCertificate()" class="cert-btn download">PNG डाउनलोड करें</button>
                    <button onclick="closeCertificateModal()" class="cert-btn close">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            currentLanguage: 'en',
            livesProtected: 0,
            knowledgePoints: 0,
            missionsCompleted: 0,
            currentMission: 'clinic',
            completedMissions: [],
            badges: []
        };

        // Mission tracking
        let selectedSymptoms = [];
        let protectedStudents = [];
        let selectedEducationMethods = [];
        let foundBreedingSites = [];
        let breedingHelpShown = false;
        let breedingAttempts = 0;
        let tutorialStep = 0;
        let sfxEnabled = true;
        let preserveStateReload = false;
        let marketGame = null; // {timerId, spawnId, remaining, caught, target, duration}
        let missionSubmissions = { clinic: false, school: false, market: false, homes: false };
        let marketLastResult = null;

        // Simple anchored explanation popover (auto-dismiss)
        function showExplanation(anchorEl, html, type = 'info') {
            const pop = document.createElement('div');
            pop.style.position = 'fixed';
            const rect = anchorEl.getBoundingClientRect();
            pop.style.left = (rect.left + rect.width / 2) + 'px';
            pop.style.top = (rect.top - 12) + 'px';
            pop.style.transform = 'translate(-50%, -100%)';
            pop.style.zIndex = '5000';
            pop.style.maxWidth = '280px';
            pop.style.padding = '10px 12px';
            pop.style.borderRadius = '10px';
            pop.style.fontSize = '0.9rem';
            pop.style.lineHeight = '1.3';
            pop.style.color = '#111827';
            pop.style.background = '#ffffff';
            pop.style.border = '2px solid ' + (type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#93c5fd');
            pop.style.boxShadow = '0 8px 24px rgba(0,0,0,0.18)';
            pop.innerHTML = html;

            document.body.appendChild(pop);
            setTimeout(() => { pop.remove(); }, 2500);
        }

        // Breeding-site explanations (correct and wrong), localized
        const breedingExplanations = {
            'water-barrel':   { correct: { en: 'Standing water in barrels can allow larvae to develop in 7–14 days.', hi: 'बाल्टियों/ड्रम में ठहरा पानी 7–14 दिनों में लार्वा विकसित होने देता है।' } },
            'plant-saucers':  { correct: { en: 'Plant saucers collect water after rain; classic larval habitat.', hi: 'गमलों की तश्तरियों में बारिश के बाद पानी जमा होता है-यह लार्वा का सामान्य ठिकाना है।' } },
            'roof-gutter':    { correct: { en: 'Blocked gutters trap water. Anopheles can breed in these pools.', hi: 'जमा/रुकी नालियों में पानी ठहरता है-ऐसे पानी में एनोफिलीज़ मच्छर प्रजनन कर सकते हैं।' } },
            'old-bucket':     { correct: { en: 'Unused buckets often hold rainwater-prime breeding habitat.', hi: 'पड़ी हुई/बेकार बाल्टियों में बारिश का पानी ठहर जाता है-प्रजनन का प्रमुख स्थान।' } },
            'flower-vase':    { correct: { en: 'Water retained in vases supports larval growth.', hi: 'फूलदानों में ठहरा पानी लार्वा के बढ़ने में मदद करता है।' } },
            'tire-planter':   { correct: { en: 'Tires collect rainwater; WHO notes them as common breeding sites.', hi: 'टायरों में बारिश का पानी भर जाता है; WHO इन्हें सामान्य प्रजनन स्थल मानता है।' } },

            'tree-base':      { wrong:   { en: 'Dry tree bases without water do not support aquatic larvae.', hi: 'पेड़ के सूखे तनों/आधार पर पानी नहीं ठहरता, इसलिए जलीय लार्वा नहीं बनते।' } },
            'dry-garden':     { wrong:   { en: 'No standing water-mosquitoes cannot complete their aquatic stages.', hi: 'ठहरा पानी नहीं है-मच्छर अपने जलीय जीवन चरण पूरे नहीं कर पाते।' } },
            'house-wall':     { wrong:   { en: 'Solid walls don\'t hold water; larvae require standing water.', hi: 'दीवार पर पानी नहीं ठहरता; लार्वा के लिए स्थिर पानी ज़रूरी है।' } },
            'flowing-drain':  { wrong:   { en: 'Flowing water flushes larvae; stagnant pools are the risk.', hi: 'बहता पानी लार्वा को बहा देता है; जोखिम स्थिर/ठहरे हुए पानी में होता है।' } },
            'solid-pavement': { wrong:   { en: 'No water retention-no larval development possible.', hi: 'यहां पानी नहीं ठहरता-लार्वा का विकास संभव नहीं।' } },
            'hanging-clothes':{ wrong:   { en: 'Clothes do not provide water; not a breeding habitat.', hi: 'कपड़े पानी नहीं रखते-यह प्रजनन स्थल नहीं है।' } }
        };

        // Clinic symptom immediate explanations
        const symptomFeedback = {
            fever:   { type: 'success', msg: 'Fever ≥38°C is the primary clinical sign in malaria (WHO).' },
            headache:{ type: 'success', msg: 'Headache is common with malaria fever paroxysms.' },
            chills:  { type: 'success', msg: 'Chills/sweats are hallmark paroxysm features.' },
            nausea:  { type: 'success', msg: 'Nausea/vomiting are frequent in pediatric malaria.' },
            fatigue: { type: 'success', msg: 'Systemic fatigue/malaise are typical with malaria.' },

            rash:    { type: 'error',   msg: 'Rash is uncommon in malaria-suggests another etiology.' },
            cough:   { type: 'error',   msg: 'Persistent cough is not typical in uncomplicated malaria.' },
            throat:  { type: 'error',   msg: 'Sore throat suggests an upper respiratory cause, not malaria.' }
        };

        // Language switching
        function switchLanguage(lang) {
            gameState.currentLanguage = lang;
            document.documentElement.setAttribute('lang', lang);
            
            // Update active language button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
            
            // Show/hide language content
            document.querySelectorAll('.lang-content').forEach(content => {
                content.classList.remove('active');
                if (content.dataset.lang === lang) {
                    content.classList.add('active');
                }
            });
            // Award bilingual badge on first Hindi use
            if (lang === 'hi') addBadge('bilingual');
            // Update badges shelf strings immediately
            updateBadgeShelf();
            // Localize glossary UI and rerender if open
            localizeGlossaryUI();
            const gloss = document.getElementById('glossary-overlay');
            if (gloss && gloss.classList.contains('active')) {
                populateGlossary();
            }
            // If tutorial is open, refresh its texts in the selected language
            const overlay = document.getElementById('tutorial-overlay');
            if (overlay && overlay.classList.contains('active')) {
                showTutorialStep();
            } else {
                // Also update the skip button labeling in case overlay opens later
                const skipBtn = document.querySelector('.tutorial-btn.secondary');
                if (skipBtn) skipBtn.textContent = (lang === 'hi' ? 'ट्यूटोरियल छोड़ें' : 'Skip Tutorial');
            }
            // If a mission modal is open, reload its content in the new language
            const missionModal = document.getElementById('mission-modal');
            if (missionModal && missionModal.classList.contains('active') && gameState.currentMission) {
                preserveStateReload = true;
                loadMissionContent(gameState.currentMission);
                // Reapply selections so in-progress choices are preserved across language switch
                reapplyMissionSelections();
                preserveStateReload = false;
            }
            // Persist choice
            try { localStorage.setItem('malariaHeroesLang', lang); } catch(e) {}
            saveProgress();
        }

        // Save progress functionality
        function saveProgress() {
            const progressData = {
                gameState: gameState,
                selectedSymptoms: selectedSymptoms,
                protectedStudents: protectedStudents,
                selectedEducationMethods: selectedEducationMethods,
                foundBreedingSites: foundBreedingSites,
                breedingHelpShown: breedingHelpShown,
                breedingAttempts: breedingAttempts,
                timestamp: Date.now()
            };
            
            try {
                localStorage.setItem('malariaHeroesProgress', JSON.stringify(progressData));
                console.log('Progress saved successfully');
                return true;
            } catch (error) {
                console.error('Failed to save progress:', error);
                return false;
            }
        }

        function loadProgress() {
            try {
                const savedData = localStorage.getItem('malariaHeroesProgress');
                if (savedData) {
                    const progressData = JSON.parse(savedData);
                    
                    // Check if save is not too old (7 days)
                    const daysSinceSave = (Date.now() - progressData.timestamp) / (1000 * 60 * 60 * 24);
                    if (daysSinceSave > 7) {
                        localStorage.removeItem('malariaHeroesProgress');
                        return false;
                    }
                    
                    // Restore game state
                    gameState = { ...gameState, ...progressData.gameState };
                    selectedSymptoms = progressData.selectedSymptoms || [];
                    protectedStudents = progressData.protectedStudents || [];
                    selectedEducationMethods = progressData.selectedEducationMethods || [];
                    foundBreedingSites = progressData.foundBreedingSites || [];
                    breedingHelpShown = progressData.breedingHelpShown || false;
                    breedingAttempts = progressData.breedingAttempts || 0;
                    
                    updateStats();
                    updateUI();
                    return true;
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
                localStorage.removeItem('malariaHeroesProgress');
            }
            return false;
        }

        function updateUI() {
            // Update location states based on completed missions
            const locations = ['clinic', 'school', 'market', 'homes'];
            locations.forEach((locationId, index) => {
                const location = document.getElementById(locationId + '-location') || document.querySelector('.' + locationId);
                if (location) {
                    if (gameState.completedMissions.includes(locationId)) {
                        location.classList.add('completed');
                        location.classList.remove('disabled');
                    } else if (index > 0 && !gameState.completedMissions.includes(locations[index - 1])) {
                        location.classList.add('disabled');
                        location.classList.remove('completed');
                    } else if (index === 0) {
                        location.classList.remove('disabled', 'completed');
                    }
                }
            });
            
            // Update current mission text
            const currentMissionText = document.getElementById('current-mission-text');
            const currentMissionTextHi = document.getElementById('current-mission-text-hi');
            
            if (gameState.completedMissions.length === 0) {
                if (currentMissionText) currentMissionText.textContent = 'Visit the Emergency Clinic where a critically ill 8-year-old patient needs immediate medical diagnosis. Lives depend on your expertise!';
                if (currentMissionTextHi) currentMissionTextHi.textContent = 'आपातकालीन क्लिनिक में जाएं जहां एक गंभीर रूप से बीमार 8 वर्षीय रोगी को तत्काल चिकित्सा निदान की आवश्यकता है। जीवन आपकी विशेषज्ञता पर निर्भर है!';
            } else if (gameState.completedMissions.length < 4) {
                const nextMission = ['school', 'market', 'homes'][gameState.completedMissions.length - 1];
                const missionTexts = {
                    school: {
                        en: 'Visit the Village School to help protect students from malaria using evidence-based strategies.',
                        hi: 'गांव के विद्यालय में जाएं और साक्ष्य-आधारित रणनीतियों का उपयोग करके छात्रों को मलेरिया से बचाने में मदद करें।'
                    },
                    market: {
                        en: 'Visit the Community Market to educate villagers about malaria prevention methods.',
                        hi: 'सामुदायिक बाजार में जाएं और ग्रामीणों को मलेरिया रोकथाम के तरीकों के बारे में शिक्षित करें।'
                    },
                    homes: {
                        en: 'Visit Family Compounds to identify and eliminate mosquito breeding sites.',
                        hi: 'पारिवारिक परिसरों में जाएं और मच्छर प्रजनन स्थलों की पहचान करें और उन्हें समाप्त करें।'
                    }
                };
                if (currentMissionText) currentMissionText.textContent = missionTexts[nextMission].en;
                if (currentMissionTextHi) currentMissionTextHi.textContent = missionTexts[nextMission].hi;
            }
        }

        // Auto-save progress every 30 seconds
        setInterval(saveProgress, 30000);

        // Save progress on page unload
        window.addEventListener('beforeunload', saveProgress);

        // Translate performance ratings
        function translatePerformance(performance, lang) {
            const translations = {
                en: {
                    'excellent': 'EXCELLENT',
                    'good': 'GOOD',
                    'satisfactory': 'SATISFACTORY',
                    'needs-improvement': 'NEEDS IMPROVEMENT'
                },
                hi: {
                    'excellent': 'उत्कृष्ट',
                    'good': 'अच्छा',
                    'satisfactory': 'संतोषजनक',
                    'needs-improvement': 'सुधार की आवश्यकता'
                }
            };
            return translations[lang][performance] || performance.toUpperCase();
        }

        // Update stats display
        function updateStats() {
            document.getElementById('livesProtected').textContent = gameState.livesProtected;
            document.getElementById('knowledgePoints').textContent = gameState.knowledgePoints;
            document.getElementById('missionsCompleted').textContent = gameState.missionsCompleted;
        }

        // Glossary System
        const glossaryTerms = [
            {
                term: "Vector Control",
                icon: "🦟",
                simple: "Stopping mosquitoes from breeding and spreading disease",
                medical: "Methods to eliminate or reduce disease-carrying organisms"
            },
            {
                term: "WHO (World Health Organization)",
                icon: "🌍",
                simple: "The world's main health authority that creates guidelines for treating diseases",
                medical: "United Nations specialized agency responsible for international public health"
            },
            {
                term: "Mortality Rate",
                icon: "📉",
                simple: "How many people die from a disease",
                medical: "The number of deaths in a population from a specific cause"
            },
            {
                term: "Anopheles Mosquito",
                icon: "🦟",
                simple: "The specific type of mosquito that carries malaria",
                medical: "Genus of mosquitoes that transmit malaria parasites"
            },
            {
                term: "Malaria Parasite",
                icon: "🔬",
                simple: "Tiny organisms that live in mosquitoes and cause malaria",
                medical: "Plasmodium species that infect human red blood cells"
            },
            {
                term: "Bed Net",
                icon: "🛏️",
                simple: "Special netting that protects people from mosquito bites while sleeping",
                medical: "Insecticide-treated netting used for malaria prevention"
            },
            {
                term: "Breeding Site",
                icon: "💧",
                simple: "Places where mosquitoes lay eggs and grow",
                medical: "Standing water locations where mosquito larvae develop"
            },
            {
                term: "Fever",
                icon: "🌡️",
                simple: "When your body temperature is higher than normal",
                medical: "Elevated body temperature above 38°C (100.4°F)"
            },
            {
                term: "Diagnosis",
                icon: "🔍",
                simple: "Finding out what disease someone has",
                medical: "Identification of a disease through examination and testing"
            },
            {
                term: "Prevention",
                icon: "🛡️",
                simple: "Stopping something bad from happening",
                medical: "Actions taken to avoid disease occurrence"
            },
            {
                term: "Epidemic",
                icon: "📈",
                simple: "When many people in an area get the same disease",
                medical: "Rapid spread of disease to many people in a short time"
            },
            {
                term: "Endemic",
                icon: "📍",
                simple: "A disease that is always present in a certain area",
                medical: "Constant presence of a disease in a geographic area"
            },
            {
                term: "Immunity",
                icon: "💪",
                simple: "Your body's ability to fight off diseases",
                medical: "Biological resistance to infectious diseases"
            },
            {
                term: "Transmission",
                icon: "🔄",
                simple: "How a disease spreads from one person to another",
                medical: "Process by which infectious agents are spread"
            },
            {
                term: "Treatment",
                icon: "💊",
                simple: "Medicine or care given to make someone better",
                medical: "Medical intervention to cure or manage disease"
            }
        ];

        // Hindi glossary terms (complete set)
        const glossaryTermsHi = [
            { term: 'वेक्टर नियंत्रण', icon: '🦟', simple: 'मच्छरों के प्रजनन और रोग फैलाने को रोकना', medical: 'रोग फैलाने वाले जीवों को कम या समाप्त करने की विधियां' },
            { term: 'WHO (विश्व स्वास्थ्य संगठन)', icon: '🌍', simple: 'दुनिया की मुख्य स्वास्थ्य संस्था जो उपचार के दिशानिर्देश बनाती है', medical: 'अंतरराष्ट्रीय सार्वजनिक स्वास्थ्य के लिए संयुक्त राष्ट्र की विशेष एजेंसी' },
            { term: 'मृत्यु दर', icon: '📉', simple: 'किसी रोग से कितने लोग मरते हैं', medical: 'किसी विशिष्ट कारण से जनसंख्या में होने वाली मौतों की संख्या' },
            { term: 'एनोफिलीज़ मच्छर', icon: '🦟', simple: 'वह खास मच्छर जो मलेरिया फैलाता है', medical: 'मलेरिया परजीवी फैलाने वाले मच्छरों का वंश' },
            { term: 'मलेरिया परजीवी', icon: '🔬', simple: 'बहुत छोटे जीव जो मच्छरों में रहते हैं और मलेरिया कराते हैं', medical: 'प्लाज्मोडियम प्रजातियां जो मानव के लाल रक्त कणों को संक्रमित करती हैं' },
            { term: 'मच्छरदानी', icon: '🛏️', simple: 'सोते समय मच्छरों के काटने से बचाने वाला जाल', medical: 'कीटनाशक-उपचारित जाल जो मलेरिया रोकथाम में उपयोग होता है' },
            { term: 'प्रजनन स्थल', icon: '💧', simple: 'जहां मच्छर अंडे देते हैं और बड़े होते हैं', medical: 'ठहरे पानी की जगह जहां मच्छर लार्वा विकसित होते हैं' },
            { term: 'बुखार', icon: '🌡️', simple: 'जब शरीर का तापमान सामान्य से अधिक हो', medical: '38°C (100.4°F) से ऊपर शरीर का तापमान' },
            { term: 'निदान', icon: '🔍', simple: 'यह पता लगाना कि किसी को कौन-सा रोग है', medical: 'जांच और परीक्षण से रोग की पहचान करना' },
            { term: 'रोकथाम', icon: '🛡️', simple: 'बुरी चीज़ होने से पहले ही रोकना', medical: 'रोग होने से बचाने के लिए किए गए कदम' },
            { term: 'महामारी', icon: '📈', simple: 'जब एक क्षेत्र में बहुत से लोगों को एक ही रोग हो जाए', medical: 'कम समय में बड़ी संख्या में लोगों में रोग का तेजी से फैलाव' },
            { term: 'स्थानिक', icon: '📍', simple: 'ऐसा रोग जो किसी क्षेत्र में हमेशा बना रहता है', medical: 'किसी भौगोलिक क्षेत्र में रोग की निरंतर उपस्थिति' },
            { term: 'प्रतिरक्षा', icon: '💪', simple: 'आपके शरीर की बीमारी से लड़ने की क्षमता', medical: 'संक्रामक रोगों के प्रति जैविक प्रतिरोध' },
            { term: 'संक्रमण प्रसार', icon: '🔄', simple: 'जब रोग एक व्यक्ति से दूसरे तक पहुंचता है', medical: 'संक्रामक कारकों के फैलने की प्रक्रिया' },
            { term: 'उपचार', icon: '💊', simple: 'दवा या देखभाल जिससे कोई बेहतर होता है', medical: 'रोग को ठीक करने या नियंत्रित करने के लिए चिकित्सा हस्तक्षेप' }
        ];

        function openGlossary() {
            document.getElementById('glossary-overlay').classList.add('active');
            localizeGlossaryUI();
            populateGlossary();
        }

        function closeGlossary() {
            document.getElementById('glossary-overlay').classList.remove('active');
        }

        // SFX toggle
        function toggleSfx() {
            sfxEnabled = !sfxEnabled;
            const btn = document.querySelector('.sfx-toggle');
            if (btn) btn.textContent = sfxEnabled ? '🔊' : '🔇';
            localStorage.setItem('malariaHeroesSfx', sfxEnabled ? 'on' : 'off');
        }

        // Fun facts for kids
        const funFacts = {
            en: [
                'Mosquitoes can lay up to 100–200 eggs at a time-removing standing water breaks their life cycle!',
                'Anopheles mosquitoes bite mostly at night-bed nets protect families while they sleep.',
                'Only female mosquitoes bite; they need blood to make eggs!',
                'Larvae need still water to breathe-covering containers stops them.',
                'Wearing long sleeves at dusk reduces bites outdoors.',
                'Closing lids on water storage prevents mosquito breeding.',
                'Changing water in flower vases every 2–3 days stops larvae.',
                'Tires collect rainwater-store them dry or under cover.',
                'Gutters should be cleaned to avoid stagnant pools.',
                'Fish in ponds can eat mosquito larvae naturally.',
                'Screened windows help block mosquitoes at night.',
                'Fans make it harder for mosquitoes to land on skin.',
                'Dark clothing attracts more mosquitoes-wear light colors.',
                'Repellents with DEET or picaridin are effective when used properly.',
                'Standing water can form in tiny places-check plant saucers!',
                'Community clean-up days reduce breeding sites for everyone.'
            ],
            hi: [
                'मच्छर एक बार में 100–200 अंडे तक दे सकते हैं-स्थिर पानी हटाने से उनका जीवन चक्र टूटता है!',
                'एनोफिलीज़ मच्छर ज़्यादातर रात में काटते हैं-मच्छरदानी सोते समय परिवारों की सुरक्षा करती है।',
                'सिर्फ मादा मच्छर काटती हैं; अंडे बनाने के लिए उन्हें रक्त चाहिए!',
                'लार्वा को सांस लेने के लिए ठहरा पानी चाहिए-ढक्कन लगाने से वे रुकते हैं।',
                'शाम के समय पूरी बाजू के कपड़े पहनना काटने को कम करता है।',
                'पानी के डिब्बों/टंकियों पर ढक्कन लगाने से मच्छरों का प्रजनन रुकता है।',
                'फूलदान का पानी हर 2–3 दिन में बदलने से लार्वा नहीं बनते।',
                'टायरों में बारिश का पानी भरता है-उन्हें सूखी जगह रखें या ढँक दें।',
                'छत की नालियां साफ रखने से पानी नहीं ठहरता।',
                'तालाब में मछलियां मच्छरों के लार्वा खा लेती हैं-यह प्राकृतिक उपाय है।',
                'जालियां लगी खिड़कियां रात में मच्छरों को अंदर आने से रोकती हैं।',
                'पंखा चलने से मच्छरों के लिए शरीर पर बैठना मुश्किल होता है।',
                'गहरे रंग के कपड़ों की तरफ मच्छर ज्यादा आकर्षित होते हैं-हल्के रंग पहनें।',
                'DEET या पिकारिडिन वाले रिपेलेंट सही तरीके से इस्तेमाल करने पर प्रभावी होते हैं।',
                'बहुत छोटे स्थानों में भी पानी ठहर सकता है-गमलों की तश्तरियां जांचें!',
                'सामुदायिक सफाई अभियान सबके लिए प्रजनन स्थल कम करते हैं।'
            ]
        };
        const funFactQueue = { en: [], hi: [] };
        function refillFunFacts(lang) {
            const src = [...(funFacts[lang] || funFacts.en)];
            // Shuffle
            for (let i = src.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [src[i], src[j]] = [src[j], src[i]];
            }
            funFactQueue[lang] = src;
        }
        function showFunFact() {
            const lang = gameState.currentLanguage in funFacts ? gameState.currentLanguage : 'en';
            if (!funFactQueue[lang] || funFactQueue[lang].length === 0) refillFunFacts(lang);
            const fact = funFactQueue[lang].shift();
            alert('💡 ' + fact);
        }

        function localizeGlossaryUI() {
            const lang = gameState.currentLanguage;
            const titleEl = document.querySelector('.glossary-title');
            const searchEl = document.getElementById('glossary-search');
            const panel = document.querySelector('#glossary-overlay .glossary-panel');
            const content = document.getElementById('glossary-content');
            if (titleEl) {
                titleEl.textContent = lang === 'hi' ? '📖 स्वास्थ्य शब्द सूची' : '📖 Hero’s Health Word List';
            }
            if (searchEl) {
                searchEl.placeholder = lang === 'hi' ? 'स्वास्थ्य शब्द खोजें...' : 'Search health words...';
            }
            // Ensure Devanagari font is used when in Hindi
            if (panel) {
                panel.classList.toggle('hindi-text', lang === 'hi');
            }
            if (content) {
                content.classList.toggle('hindi-text', lang === 'hi');
            }
        }

        // Normalize em-dashes in 'Learn more' links to hyphens
        function normalizeLearnMoreDashes() {
            document.querySelectorAll('.learn-more .resource-link').forEach(a => {
                if (a && a.textContent) a.textContent = a.textContent.replace(/\u2014/g, '-').replace(/—/g, '-');
                if (a && a.title) a.title = a.title.replace(/\u2014/g, '-').replace(/—/g, '-');
            });
        }

        function populateGlossary() {
            const content = document.getElementById('glossary-content');
            content.innerHTML = '';

            const lang = gameState.currentLanguage;
            let terms = (lang === 'hi' ? glossaryTermsHi : glossaryTerms);
            if (!Array.isArray(terms) || terms.length === 0) {
                // Fallback to English to avoid blank list
                terms = glossaryTerms;
            }
            const medicalLabel = lang === 'hi' ? 'चिकित्सीय:' : 'Medical:';

            terms.forEach(term => {
                const termDiv = document.createElement('div');
                termDiv.className = 'glossary-term';
                termDiv.innerHTML = `
                    <div class="term-title">
                        <span>${term.icon}</span>
                        ${term.term}
                    </div>
                    <div class="term-simple">${term.simple}</div>
                    <div class="term-medical">${medicalLabel} ${term.medical}</div>
                `;
                content.appendChild(termDiv);
            });

            // Add search functionality
            const searchInput = document.getElementById('glossary-search');
            if (searchInput) {
                searchInput.removeEventListener('input', filterGlossary);
                searchInput.addEventListener('input', filterGlossary);
            }
        }

        function filterGlossary() {
            const searchTerm = document.getElementById('glossary-search').value.toLowerCase();
            const terms = document.querySelectorAll('.glossary-term');
            
            terms.forEach(term => {
                const text = term.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    term.style.display = 'block';
                } else {
                    term.style.display = 'none';
                }
            });
        }

        // Expandable Feedback Functions
        function createExpandableSection(title, content, icon = "🔬") {
            const section = document.createElement('div');
            section.className = 'expandable-section';
            section.innerHTML = `
                <div class="expandable-header" onclick="toggleExpandable(this)">
                    <div class="expandable-title">
                        <span>${icon}</span>
                        ${title}
                    </div>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-body">
                        ${content}
                    </div>
                </div>
            `;
            return section;
        }

        function toggleExpandable(header) {
            const content = header.nextElementSibling;
            const isExpanded = header.classList.contains('expanded');
            
            if (isExpanded) {
                header.classList.remove('expanded');
                content.classList.remove('expanded');
            } else {
                header.classList.add('expanded');
                content.classList.add('expanded');
            }
        }

        const tutorialSteps = [
            {
                mascot: '🦟',
                title: 'Welcome to Malaria Heroes!',
                content: 'You\'re about to become a malaria prevention expert! This game will teach you how to save lives using real WHO guidelines and scientific evidence.',
                nextText: 'Let\'s Start!'
            },
            {
                mascot: '🗺️',
                title: 'Navigate the Village Map',
                content: 'Click on the location cards to start missions. Each location has different challenges that teach you about malaria prevention.',
                nextText: 'Got It!'
            },
            {
                mascot: '📊',
                title: 'Understanding Your Progress',
                content: 'Watch your stats grow as you complete missions! Knowledge Points show how much you\'ve learned, and Lives Protected shows your real impact.',
                nextText: 'Continue'
            },
            {
                mascot: '🔬',
                title: 'Learn from WHO Guidelines',
                content: 'Every decision you make is based on real scientific evidence. Read the detailed explanations to understand why certain choices save more lives.',
                nextText: 'Almost Done!'
            },
            {
                mascot: '🏆',
                title: 'Ready to Save Nyanja Village!',
                content: 'You\'re all set! Remember: there are no wrong answers here - every choice teaches you something valuable. Let\'s start saving lives!',
                nextText: 'Start Mission!'
            }
        ];

        // Hindi tutorial steps
        const tutorialStepsHi = [
            {
                mascot: '🦟',
                title: 'मलेरिया वीर में आपका स्वागत है!',
                content: 'आप अब मलेरिया रोकथाम विशेषज्ञ बनने वाले हैं! यह खेल आपको वास्तविक WHO दिशानिर्देशों और वैज्ञानिक साक्ष्यों के आधार पर जान बचाने के तरीके सिखाएगा।',
                nextText: 'शुरू करें!'
            },
            {
                mascot: '🗺️',
                title: 'गांव के नक्शे पर नेविगेट करें',
                content: 'मिशन शुरू करने के लिए स्थान कार्ड पर क्लिक करें। हर स्थान पर अलग-अलग चुनौतियां हैं जो आपको मलेरिया रोकथाम के बारे में सिखाती हैं।',
                nextText: 'समझ गया!'
            },
            {
                mascot: '📊',
                title: 'अपनी प्रगति को समझें',
                content: 'जैसे-जैसे आप मिशन पूरे करते हैं, आपके आँकड़े बढ़ते हैं! ज्ञान अंक आपकी सीख दिखाते हैं, और संरक्षित जीवन आपके वास्तविक प्रभाव को दर्शाते हैं।',
                nextText: 'आगे बढ़ें'
            },
            {
                mascot: '🔬',
                title: 'WHO दिशानिर्देशों से सीखें',
                content: 'आपका हर निर्णय वैज्ञानिक साक्ष्यों पर आधारित है। विस्तृत व्याख्या पढ़ें ताकि समझ सकें कि कौन से विकल्प अधिक जीवन बचाते हैं।',
                nextText: 'लगभग हो गया!'
            },
            {
                mascot: '🏆',
                title: 'न्यांजा गांव को बचाने के लिए तैयार!',
                content: 'आप तैयार हैं! याद रखें: यहाँ कोई गलत जवाब नहीं-हर चुनाव कुछ नया सिखाता है। चलिए, जीवन बचाते हैं!',
                nextText: 'मिशन शुरू करें!'
            }
        ];

        function getTutorialSteps() {
            return gameState.currentLanguage === 'hi' ? tutorialStepsHi : tutorialSteps;
        }

        function startTutorial() {
            tutorialStep = 0;
            showTutorialStep();
            document.getElementById('tutorial-overlay').classList.add('active');
        }

        function showTutorialStep() {
            const steps = getTutorialSteps();
            const step = steps[tutorialStep];
            document.getElementById('tutorial-mascot').textContent = step.mascot;
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-content').textContent = step.content;
            document.getElementById('tutorial-next').textContent = step.nextText;
            // Localize skip button too
            const skipBtn = document.querySelector('.tutorial-btn.secondary');
            if (skipBtn) skipBtn.textContent = (gameState.currentLanguage === 'hi' ? 'ट्यूटोरियल छोड़ें' : 'Skip Tutorial');

            // Update progress dots
            for (let i = 1; i <= 5; i++) {
                const dot = document.getElementById(`progress-${i}`);
                if (i <= tutorialStep + 1) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            }
        }

        function nextTutorialStep() {
            tutorialStep++;
            if (tutorialStep >= tutorialSteps.length) {
                closeTutorial();
            } else {
                showTutorialStep();
            }
        }

        function skipTutorial() {
            closeTutorial();
        }

        function closeTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
            // Mark tutorial as completed
            localStorage.setItem('malariaHeroesTutorialComplete', 'true');
        }

        // Initialize game
        function initializeGame() {
            // Check if we're on GitHub Pages or similar hosting
            const isGitHubHosted = window.location.hostname.includes('github.io') || 
                                  window.location.hostname.includes('github.com') ||
                                  window.location.hostname.includes('pages.dev') ||
                                  window.location.hostname.includes('netlify.app');
            
            // For GitHub hosting, always start fresh and clear any saved progress
            if (isGitHubHosted) {
                localStorage.removeItem('malariaHeroesProgress');
                localStorage.removeItem('malariaHeroesTutorialComplete');
                console.log('GitHub hosting detected - starting fresh game');
                updateStats();
                updateUI();
                updateBadgeShelf();
                
                // Do not auto-open tutorial on first load (avoid blocking clicks)
                return;
            }
            
            // Apply stored SFX preference & last language
            try {
                const s = localStorage.getItem('malariaHeroesSfx');
                if (s === 'off') toggleSfx();
                const savedLang = localStorage.getItem('malariaHeroesLang');
                if (savedLang && savedLang !== gameState.currentLanguage) switchLanguage(savedLang);
            } catch (e) {}

            // For local hosting, try to load saved progress
            if (loadProgress()) {
                console.log('Previous progress loaded');
                updateBadgeShelf();
            } else {
                console.log('Starting new game');
                updateStats();
                updateUI();
                
                // Do not auto-open tutorial on first load (avoid blocking clicks)
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Safety: ensure overlays are not active at start
            var mm = document.getElementById('mission-modal'); if (mm) mm.classList.remove('active');
            var cm = document.getElementById('completion-modal'); if (cm) cm.classList.remove('active');
            var go = document.getElementById('glossary-overlay'); if (go) go.classList.remove('active');
            var to = document.getElementById('tutorial-overlay'); if (to) to.classList.remove('active');
            initializeGame();
        });

        // Open mission modal
        function openMission(missionId) {
            const location = document.getElementById(missionId + '-location') || document.querySelector('.' + missionId);
            
            // Always open at top of modal content
            const modalBox = document.querySelector('#mission-modal .modal-content');
            if (modalBox) modalBox.scrollTop = 0;
            
            if (location && location.classList.contains('disabled')) {
                const messages = {
                    en: 'Complete previous missions first!',
                    hi: 'पहले पिछले मिशन पूरे करें!'
                };
                alert(messages[gameState.currentLanguage]);
                return;
            }
            
            if (gameState.completedMissions.includes(missionId)) {
                const messages = {
                    en: 'Mission already completed!',
                    hi: 'मिशन पहले से पूरा है!'
                };
                alert(messages[gameState.currentLanguage]);
                return;
            }

            document.getElementById('mission-modal').classList.add('active');
            gameState.currentMission = missionId;
            loadMissionContent(missionId);
        }

        // Close mission modal
        function closeMissionModal() {
            document.getElementById('mission-modal').classList.remove('active');
            // Stop market game if running
            if (marketGame) stopMarketGame();
            // Ensure map reflects latest mission unlocks on close
            updateUI();
        }

        // Load mission content
        function loadMissionContent(missionId) {
            // Ensure scroll to top whenever mission content changes
            const modalBox = document.querySelector('#mission-modal .modal-content');
            if (modalBox) modalBox.scrollTop = 0;
            const titles = {
                en: {
                    clinic: '🏥 Emergency Clinic - Patient Diagnosis',
                    school: '🏫 Village School - Student Protection',
                    market: '🏪 Community Market - Health Education',
                    homes: '🏠 Family Compounds - Vector Control'
                },
                hi: {
                    clinic: '🏥 आपातकालीन क्लिनिक - रोगी निदान',
                    school: '🏫 गांव का विद्यालय - छात्र संरक्षण',
                    market: '🏪 सामुदायिक बाजार - स्वास्थ्य शिक्षा',
                    homes: '🏠 पारिवारिक परिसर - वेक्टर नियंत्रण'
                }
            };

            document.getElementById('modal-title').textContent = titles[gameState.currentLanguage][missionId];

            if (missionId === 'clinic') {
                loadClinicMission();
            } else if (missionId === 'school') {
                loadSchoolMission();
            } else if (missionId === 'market') {
                loadMarketMission();
            } else if (missionId === 'homes') {
                loadHomesMission();
            }
        }

        // CLINIC MISSION
        function loadClinicMission() {
            if (!preserveStateReload) selectedSymptoms = [];
            const content = {
                en: `
                    <div class="mission-intro">
                        <div class="npc-dialogue">
                            <div class="npc-avatar">👨‍⚕️</div>
                            <div class="dialogue-bubble">
<div class="npc-name">Dr. K. A. - Head of Emergency Medicine</div>
                                <p>"We have a critically ill 8-year-old child with high fever. The symptoms started 3 days ago and are worsening rapidly. I need your expertise to identify which symptoms are consistent with malaria based on WHO clinical guidelines. Every second counts!"</p>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-section">
                        <h3 class="challenge-title">🩺 Clinical Symptom Assessment</h3>
                        <p class="challenge-description">Select ALL symptoms that are consistent with malaria diagnosis according to WHO 2024 guidelines. Accurate identification is crucial for immediate treatment.</p>
                        
                        <div class="options-grid">
                            <div class="option-card" data-symptom="fever" onclick="toggleSymptom('fever')">
                                <div class="option-icon">🌡️</div>
                                <div class="option-name">High fever (39.5°C)</div>
                            </div>
                            <div class="option-card" data-symptom="headache" onclick="toggleSymptom('headache')">
                                <div class="option-icon">🤕</div>
                                <div class="option-name">Severe headache</div>
                            </div>
                            <div class="option-card" data-symptom="chills" onclick="toggleSymptom('chills')">
                                <div class="option-icon">🥶</div>
                                <div class="option-name">Chills and sweats</div>
                            </div>
                            <div class="option-card" data-symptom="nausea" onclick="toggleSymptom('nausea')">
                                <div class="option-icon">🤢</div>
                                <div class="option-name">Nausea and vomiting</div>
                            </div>
                            <div class="option-card" data-symptom="fatigue" onclick="toggleSymptom('fatigue')">
                                <div class="option-icon">😴</div>
                                <div class="option-name">Extreme fatigue</div>
                            </div>
                            <div class="option-card" data-symptom="rash" onclick="toggleSymptom('rash')">
                                <div class="option-icon">🔴</div>
                                <div class="option-name">Skin rash</div>
                            </div>
                            <div class="option-card" data-symptom="cough" onclick="toggleSymptom('cough')">
                                <div class="option-icon">😷</div>
                                <div class="option-name">Persistent cough</div>
                            </div>
                            <div class="option-card" data-symptom="throat" onclick="toggleSymptom('throat')">
                                <div class="option-icon">😣</div>
                                <div class="option-name">Sore throat</div>
                            </div>
                        </div>
                        
                        <div class="feedback-panel" id="clinic-feedback"></div>
                        <button class="action-btn" id="clinic-submit" onclick="evaluateClinicDiagnosis()" disabled>🩺 Submit Diagnosis</button>
<div class="learn-more" style="margin-top:1rem;">
                            <h4>📚 Learn more</h4>
<div class="learn-grid">
                            <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/guidelines-for-malaria" target="_blank" rel="noopener">WHO - Malaria guidelines</a>
                            <a class="resource-link" href="https://www.cdc.gov/malaria/about/index.html" target="_blank" rel="noopener">CDC - Malaria (about, symptoms, diagnosis)</a>
                            <a class="resource-link" href="https://www.khanacademy.org/science/health-and-medicine/infectious-diseases/malaria/v/the-basics-of-malaria" target="_blank" rel="noopener">Video - Khan Academy: The basics of malaria</a>
                            <a class="resource-link" href="https://www.youtube.com/watch?v=qw6jnFqZ-Hk" target="_blank" rel="noopener">Video - What is malaria: causes, diagnosis, treatment</a>
                            </div>
                        </div>
                    </div>
                `,
                hi: `
                    <div class="mission-intro">
                        <div class="npc-dialogue">
                            <div class="npc-avatar">👨‍⚕️</div>
                            <div class="dialogue-bubble">
<div class="npc-name">डॉ. के. ए. - आपातकालीन चिकित्सा प्रमुख</div>
                                <p>"हमारे पास तेज बुखार के साथ गंभीर रूप से बीमार 8 साल का बच्चा है। लक्षण 3 दिन पहले शुरू हुए और तेजी से बिगड़ रहे हैं। मुझे आपकी विशेषज्ञता की आवश्यकता है कि WHO नैदानिक दिशानिर्देशों के आधार पर कौन से लक्षण मलेरिया के अनुकूल हैं। हर सेकंड मायने रखता है!"</p>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-section">
                        <h3 class="challenge-title">🩺 नैदानिक लक्षण मूल्यांकन</h3>
                        <p class="challenge-description">WHO 2024 दिशानिर्देशों के अनुसार मलेरिया निदान के अनुकूल सभी लक्षणों का चयन करें। तत्काल उपचार के लिए सटीक पहचान महत्वपूर्ण है।</p>
                        
                        <div class="options-grid">
                            <div class="option-card" data-symptom="fever" onclick="toggleSymptom('fever')">
                                <div class="option-icon">🌡️</div>
                                <div class="option-name">तेज बुखार (39.5°C)</div>
                            </div>
                            <div class="option-card" data-symptom="headache" onclick="toggleSymptom('headache')">
                                <div class="option-icon">🤕</div>
                                <div class="option-name">तीव्र सिरदर्द</div>
                            </div>
                            <div class="option-card" data-symptom="chills" onclick="toggleSymptom('chills')">
                                <div class="option-icon">🥶</div>
                                <div class="option-name">कंपकंपी और पसीना</div>
                            </div>
                            <div class="option-card" data-symptom="nausea" onclick="toggleSymptom('nausea')">
                                <div class="option-icon">🤢</div>
                                <div class="option-name">मतली और उल्टी</div>
                            </div>
                            <div class="option-card" data-symptom="fatigue" onclick="toggleSymptom('fatigue')">
                                <div class="option-icon">😴</div>
                                <div class="option-name">अत्यधिक थकान</div>
                            </div>
                            <div class="option-card" data-symptom="rash" onclick="toggleSymptom('rash')">
                                <div class="option-icon">🔴</div>
                                <div class="option-name">त्वचा पर दाने</div>
                            </div>
                            <div class="option-card" data-symptom="cough" onclick="toggleSymptom('cough')">
                                <div class="option-icon">😷</div>
                                <div class="option-name">लगातार खांसी</div>
                            </div>
                            <div class="option-card" data-symptom="throat" onclick="toggleSymptom('throat')">
                                <div class="option-icon">😣</div>
                                <div class="option-name">गले में खराश</div>
                            </div>
                        </div>
                        
                        <div class="feedback-panel" id="clinic-feedback"></div>
                        <button class="action-btn" id="clinic-submit" onclick="evaluateClinicDiagnosis()" disabled>🩺 निदान प्रस्तुत करें</button>
<div class="learn-more" style="margin-top:1rem;">
                            <h4>📚 और जानें</h4>
<div class="learn-grid">
                            <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/guidelines-for-malaria" target="_blank" rel="noopener">WHO - Malaria guidelines</a>
                            <a class="resource-link" href="https://www.cdc.gov/malaria/about/index.html" target="_blank" rel="noopener">CDC - Malaria (about, symptoms, diagnosis)</a>
                            <a class="resource-link" href="https://www.khanacademy.org/science/health-and-medicine/infectious-diseases/malaria/v/the-basics-of-malaria" target="_blank" rel="noopener">Video - Khan Academy: The basics of malaria</a>
                            <a class="resource-link" href="https://www.youtube.com/watch?v=qw6jnFqZ-Hk" target="_blank" rel="noopener">Video - What is malaria: causes, diagnosis, treatment</a>
                            </div>
                        </div>
                    </div>
                `
            };
            
            document.getElementById('modal-content').innerHTML = content[gameState.currentLanguage];
            normalizeLearnMoreDashes();
        }

        // Toggle symptom selection (no explanations until submit)
        function toggleSymptom(symptomId) {
            const symptomCard = document.querySelector(`[data-symptom="${symptomId}"]`);

            const wasSelected = selectedSymptoms.includes(symptomId);
            if (wasSelected) {
                selectedSymptoms = selectedSymptoms.filter(s => s !== symptomId);
                symptomCard.classList.remove('selected');
                playSound('incorrect');
            } else {
                selectedSymptoms.push(symptomId);
                symptomCard.classList.add('selected');
                playSound('correct');
            }

            // Do not show any correctness explanation here; defer to evaluateClinicDiagnosis
            document.getElementById('clinic-submit').disabled = selectedSymptoms.length === 0;
            saveProgress();
        }

        // Evaluate clinic diagnosis
        function evaluateClinicDiagnosis(opts = {}) {
            const correctSymptoms = ['fever', 'headache', 'chills', 'nausea', 'fatigue'];
            const allSymptoms = ['fever', 'headache', 'chills', 'nausea', 'fatigue', 'rash', 'cough', 'throat'];
            
            let correctCount = 0;
            let incorrectCount = 0;
            
            // Mark selected picks
            selectedSymptoms.forEach(symptomId => {
                const card = document.querySelector(`[data-symptom="${symptomId}"]`);
                if (!card) return;
                if (correctSymptoms.includes(symptomId)) {
                    card.classList.add('correct');
                    correctCount++;
                } else {
                    card.classList.add('incorrect');
                    incorrectCount++;
                }
            });
            // Highlight missed correct answers (not selected)
            correctSymptoms.forEach(symptomId => {
                if (!selectedSymptoms.includes(symptomId)) {
                    const card = document.querySelector(`[data-symptom="${symptomId}"]`);
                    if (card) card.classList.add('missed');
                }
            });
            
            const feedbackPanel = document.getElementById('clinic-feedback');
            feedbackPanel.innerHTML = '';
            const lang = gameState.currentLanguage;
            
            // WHO quick summary
            const whoSummary = lang === 'en'
                ? 'WHO: Core clinical features of malaria include fever, headache, chills/sweats, nausea/vomiting, and malaise/fatigue. Respiratory symptoms (e.g., persistent cough) and rash are not typical of uncomplicated malaria.'
                : 'WHO: मलेरिया के मुख्य नैदानिक लक्षणों में बुखार, सिरदर्द, कंपकंपी/पसीना, मतली/उल्टी और बेचैनी/थकान शामिल हैं। श्वसन लक्षण (जैसे लगातार खांसी) और दाने असामान्य मलेरिया में सामान्य नहीं हैं।';
            
            let explanationHTML = `<div style="margin-top:1rem;">
                <div style="padding:1rem;border-left:4px solid var(--hero-blue);background:#eff6ff;border-radius:8px;">
                    <strong>WHO</strong>: ${whoSummary}
                </div>`;
            
            // Explanations per symptom (full answer key)
            const symptomExplanations = {
                en: {
                    fever: '✅ High fever (≥38°C): primary clinical sign in endemic areas',
                    headache: '✅ Headache: part of classic malaria symptom triad',
                    chills: '✅ Chills and sweats: hallmark febrile paroxysms',
                    nausea: '✅ Nausea/vomiting: common, especially in children',
                    fatigue: '✅ Fatigue/malaise: typical systemic response',
                    rash: '❌ Rash: not typical of malaria (consider viral/allergic causes)',
                    cough: '❌ Persistent cough: uncommon in uncomplicated malaria',
                    throat: '❌ Sore throat: suggests upper respiratory infection, not malaria'
                },
                hi: {
                    fever: '✅ तेज बुखार (≥38°C): स्थानिक क्षेत्रों में प्राथमिक संकेत',
                    headache: '✅ सिरदर्द: मलेरिया के क्लासिक लक्षणों का हिस्सा',
                    chills: '✅ कंपकंपी/पसीना: ज्वर की विशिष्ट अवस्था',
                    nausea: '✅ मतली/उल्टी: विशेषकर बच्चों में सामान्य',
                    fatigue: '✅ थकान/बेचैनी: सामान्य प्रणालीगत प्रतिक्रिया',
                    rash: '❌ दाने: मलेरिया का विशिष्ट लक्षण नहीं (अन्य कारण देखें)',
                    cough: '❌ लगातार खांसी: असामान्य मलेरिया में सामान्य नहीं',
                    throat: '❌ गले में खराश: ऊपरी श्वसन संक्रमण का संकेत'
                }
            };
            
            explanationHTML += '<ul style="margin-top:0.75rem">';
            allSymptoms.forEach(symptomId => {
                const isCorrect = correctSymptoms.includes(symptomId);
                const color = isCorrect ? '#059669' : '#b91c1c';
                explanationHTML += `<li style="margin-bottom:0.5rem;color:${color}">${symptomExplanations[lang][symptomId]}</li>`;
            });
            explanationHTML += '</ul>';
            
            // Scoring
            const accuracy = correctCount / correctSymptoms.length;
            let performance, points, lives;
            if (accuracy >= 0.8 && incorrectCount === 0) {
                performance = 'excellent'; points = 150; lives = 12;
            } else if (accuracy >= 0.6) {
                performance = 'good'; points = 100; lives = 8;
            } else if (accuracy >= 0.4) {
                performance = 'satisfactory'; points = 75; lives = 5;
            } else {
                performance = 'needs-improvement'; points = 50; lives = 3;
            }
            if (!opts.dryRun) {
                gameState.knowledgePoints += points;
                gameState.livesProtected += lives;
                updateStats();
                // Award WHO Scholar badge for high accuracy without errors
                if (accuracy >= 0.8 && incorrectCount === 0) addBadge('who_scholar');
            }
            missionSubmissions.clinic = true;
            
            explanationHTML += '<div style="margin-top:1rem;padding:1rem;background:#f0fdf4;border-radius:8px;border-left:4px solid var(--victory-green);">';
            explanationHTML += '<h5>' + (lang === 'en' ? 'Mission Results:' : 'मिशन परिणाम:') + '</h5>';
            explanationHTML += '<p>📈 <strong>' + (lang === 'en' ? 'Knowledge Points Earned:' : 'अर्जित ज्ञान अंक:') + '</strong> ' + points + '</p>';
            explanationHTML += '<p>💚 <strong>' + (lang === 'en' ? 'Lives Protected:' : 'संरक्षित जीवन:') + '</strong> ' + lives + '</p>';
            explanationHTML += '<p>🏆 <strong>' + (lang === 'en' ? 'Performance:' : 'प्रदर्शन:') + '</strong> ' + translatePerformance(performance, lang) + '</p>';
            explanationHTML += '</div></div>';
            
            feedbackPanel.innerHTML = explanationHTML;
            feedbackPanel.classList.add('show');
            
            const continueText = gameState.currentLanguage === 'en' ? '🚀 Continue to Next Mission' : '🚀 अगले मिशन पर जारी रखें';
            document.getElementById('clinic-submit').textContent = continueText;
            document.getElementById('clinic-submit').onclick = () => proceedToNextMissionFrom('clinic');
            // Mark mission complete but keep modal open so closing with X still unlocks next
            if (!opts.dryRun) setMissionCompleted('clinic', { skipClose: true });
        }

        // SCHOOL MISSION
        function loadSchoolMission() {
            if (!preserveStateReload) protectedStudents = [];
            const content = {
                en: `
                    <div class="mission-intro">
                        <div class="npc-dialogue">
                            <div class="npc-avatar">👨‍🏫</div>
                            <div class="dialogue-bubble">
<div class="npc-name">Principal J. K.</div>
                                <p>"We have 12 students who need protection, but only 7 bed nets available! WHO data shows children under 10 have much higher malaria mortality rates. Please help us prioritize which students to protect based on their age and vulnerability."</p>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-section">
                        <h3 class="challenge-title">🛡️ Evidence-Based Student Protection</h3>
                        <p class="challenge-description">Select 7 students to receive bed net protection. Prioritize based on WHO vulnerability data: younger children (under 10) are at highest risk.</p>
                        
                        <div class="student-grid">
                            <div class="student-card high-risk" data-student="0" onclick="toggleStudentProtection(0)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Ama</div>
                                <div class="student-age">Age 8</div>
                            </div>
                            <div class="student-card high-risk" data-student="1" onclick="toggleStudentProtection(1)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Kofi</div>
                                <div class="student-age">Age 9</div>
                            </div>
                            <div class="student-card medium-risk" data-student="2" onclick="toggleStudentProtection(2)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Esi</div>
                                <div class="student-age">Age 10</div>
                            </div>
                            <div class="student-card medium-risk" data-student="3" onclick="toggleStudentProtection(3)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Yaw</div>
                                <div class="student-age">Age 11</div>
                            </div>
                            <div class="student-card low-risk" data-student="4" onclick="toggleStudentProtection(4)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Akua</div>
                                <div class="student-age">Age 12</div>
                            </div>
                            <div class="student-card low-risk" data-student="5" onclick="toggleStudentProtection(5)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Kwame</div>
                                <div class="student-age">Age 13</div>
                            </div>
                            <div class="student-card low-risk" data-student="6" onclick="toggleStudentProtection(6)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Afia</div>
                                <div class="student-age">Age 14</div>
                            </div>
                            <div class="student-card high-risk" data-student="7" onclick="toggleStudentProtection(7)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Kojo</div>
                                <div class="student-age">Age 8</div>
                            </div>
                            <div class="student-card medium-risk" data-student="8" onclick="toggleStudentProtection(8)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Adwoa</div>
                                <div class="student-age">Age 10</div>
                            </div>
                            <div class="student-card high-risk" data-student="9" onclick="toggleStudentProtection(9)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Yaa</div>
                                <div class="student-age">Age 9</div>
                            </div>
                            <div class="student-card low-risk" data-student="10" onclick="toggleStudentProtection(10)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Kweku</div>
                                <div class="student-age">Age 13</div>
                            </div>
                            <div class="student-card low-risk" data-student="11" onclick="toggleStudentProtection(11)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">Akosua</div>
                                <div class="student-age">Age 12</div>
                            </div>
                        </div>
                        
                        <div class="feedback-panel" id="school-feedback"></div>
                        <button class="action-btn" id="school-submit" onclick="evaluateSchoolProtection()" disabled>🛡️ Implement Protection Plan</button>
<div class="learn-more" style="margin-top:1rem;">
                            <h4>📚 Learn more</h4>
<div class="learn-grid">
                                <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/prevention/insecticide-treated-nets" target="_blank" rel="noopener">WHO - Insecticide-treated nets (ITNs)</a>
                                <a class="resource-link" href="https://www.malariaconsortium.org/resources/integrating-malaria-education-into-primary-school-activities" target="_blank" rel="noopener">Malaria Consortium - School activities</a>
                                <a class="resource-link" href="https://www.childrenforhealth.org/100messages/malaria/" target="_blank" rel="noopener">Children for Health - Malaria messages</a>
                                <a class="resource-link" href="https://www.aboutkidshealth.ca/malaria" target="_blank" rel="noopener">AboutKidsHealth - Malaria (children/parents)</a>
                            </div>
                        </div>
                    </div>
                `,
                hi: `
                    <div class="mission-intro">
                        <div class="npc-dialogue">
                            <div class="npc-avatar">👨‍🏫</div>
                            <div class="dialogue-bubble">
<div class="npc-name">प्राचार्य जे. के.</div>
                                <p>"हमारे पास 12 छात्र हैं जिन्हें सुरक्षा की आवश्यकता है, लेकिन केवल 7 मच्छरदानी उपलब्ध हैं! WHO डेटा दर्शाता है कि 10 वर्ष से कम उम्र के बच्चों में मलेरिया मृत्यु दर बहुत अधिक है। कृपया हमारी सहायता करें यह प्राथमिकता तय करने में कि उनकी उम्र और संवेदनशीलता के आधार पर किन छात्रों को सुरक्षा दी जाए।"</p>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-section">
                        <h3 class="challenge-title">🛡️ साक्ष्य-आधारित छात्र संरक्षण</h3>
                        <p class="challenge-description">मच्छरदानी सुरक्षा प्राप्त करने के लिए 7 छात्रों का चयन करें। WHO संवेदनशीलता डेटा के आधार पर प्राथमिकता दें: छोटे बच्चे (10 वर्ष से कम) उच्चतम जोखिम में हैं।</p>
                        
                        <div class="student-grid">
                            <div class="student-card high-risk" data-student="0" onclick="toggleStudentProtection(0)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">अमा</div>
                                <div class="student-age">आयु 8</div>
                            </div>
                            <div class="student-card high-risk" data-student="1" onclick="toggleStudentProtection(1)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">कोफी</div>
                                <div class="student-age">आयु 9</div>
                            </div>
                            <div class="student-card medium-risk" data-student="2" onclick="toggleStudentProtection(2)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">एसी</div>
                                <div class="student-age">आयु 10</div>
                            </div>
                            <div class="student-card medium-risk" data-student="3" onclick="toggleStudentProtection(3)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">याव</div>
                                <div class="student-age">आयु 11</div>
                            </div>
                            <div class="student-card low-risk" data-student="4" onclick="toggleStudentProtection(4)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">अकुआ</div>
                                <div class="student-age">आयु 12</div>
                            </div>
                            <div class="student-card low-risk" data-student="5" onclick="toggleStudentProtection(5)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">क्वामे</div>
                                <div class="student-age">आयु 13</div>
                            </div>
                            <div class="student-card low-risk" data-student="6" onclick="toggleStudentProtection(6)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">अफिया</div>
                                <div class="student-age">आयु 14</div>
                            </div>
                            <div class="student-card high-risk" data-student="7" onclick="toggleStudentProtection(7)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">कोजो</div>
                                <div class="student-age">आयु 8</div>
                            </div>
                            <div class="student-card medium-risk" data-student="8" onclick="toggleStudentProtection(8)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">अदवोआ</div>
                                <div class="student-age">आयु 10</div>
                            </div>
                            <div class="student-card high-risk" data-student="9" onclick="toggleStudentProtection(9)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">याआ</div>
                                <div class="student-age">आयु 9</div>
                            </div>
                            <div class="student-card low-risk" data-student="10" onclick="toggleStudentProtection(10)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">क्वेकू</div>
                                <div class="student-age">आयु 13</div>
                            </div>
                            <div class="student-card low-risk" data-student="11" onclick="toggleStudentProtection(11)">
                                <div class="bed-icon">🛏️</div>
                                <div class="student-name">अकोसुआ</div>
                                <div class="student-age">आयु 12</div>
                            </div>
                        </div>
                        
                        <div class="feedback-panel" id="school-feedback"></div>
                        <button class="action-btn" id="school-submit" onclick="evaluateSchoolProtection()" disabled>🛡️ सुरक्षा योजना लागू करें</button>
<div class="learn-more" style="margin-top:1rem;">
                            <h4>📚 और जानें</h4>
<div class="learn-grid">
                                <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/prevention/insecticide-treated-nets" target="_blank" rel="noopener">WHO - Insecticide-treated nets (ITNs)</a>
                                <a class="resource-link" href="https://www.malariaconsortium.org/resources/integrating-malaria-education-into-primary-school-activities" target="_blank" rel="noopener">Malaria Consortium - School activities</a>
                                <a class="resource-link" href="https://www.childrenforhealth.org/100messages/malaria/" target="_blank" rel="noopener">Children for Health - Malaria messages</a>
                                <a class="resource-link" href="https://www.aboutkidshealth.ca/malaria" target="_blank" rel="noopener">AboutKidsHealth - Malaria</a>
                            </div>
                        </div>
                    </div>
                `
            };
            
            document.getElementById('modal-content').innerHTML = content[gameState.currentLanguage];
            normalizeLearnMoreDashes();
        }

        // Toggle student protection
        function toggleStudentProtection(studentIndex) {
            const studentCard = document.querySelector(`[data-student="${studentIndex}"]`);
            
            if (protectedStudents.includes(studentIndex)) {
                protectedStudents = protectedStudents.filter(s => s !== studentIndex);
                studentCard.classList.remove('protected');
            } else if (protectedStudents.length < 7) {
                protectedStudents.push(studentIndex);
                studentCard.classList.add('protected');
            } else {
                const messages = {
                    en: 'Only 7 bed nets available! Remove protection from another student first.',
                    hi: 'केवल 7 मच्छरदानी उपलब्ध हैं! पहले किसी अन्य छात्र से सुरक्षा हटाएं।'
                };
                alert(messages[gameState.currentLanguage]);
                return;
            }
            
            document.getElementById('school-submit').disabled = protectedStudents.length !== 7;
            saveProgress();
        }

        // Evaluate school protection
        function evaluateSchoolProtection(opts = {}) {
            const students = [
                { name: 'Ama', age: 8, risk: 'HIGH' },
                { name: 'Kofi', age: 9, risk: 'HIGH' },
                { name: 'Esi', age: 10, risk: 'MEDIUM' },
                { name: 'Yaw', age: 11, risk: 'MEDIUM' },
                { name: 'Akua', age: 12, risk: 'LOW' },
                { name: 'Kwame', age: 13, risk: 'LOW' },
                { name: 'Afia', age: 14, risk: 'LOW' },
                { name: 'Kojo', age: 8, risk: 'HIGH' },
                { name: 'Adwoa', age: 10, risk: 'MEDIUM' },
                { name: 'Yaa', age: 9, risk: 'HIGH' },
                { name: 'Kweku', age: 13, risk: 'LOW' },
                { name: 'Akosua', age: 12, risk: 'LOW' }
            ];
            
            let highRiskProtected = 0;
            let mediumRiskProtected = 0;
            let lowRiskProtected = 0;
            
            protectedStudents.forEach(index => {
                const student = students[index];
                if (student.age <= 9) highRiskProtected++;
                else if (student.age <= 11) mediumRiskProtected++;
                else lowRiskProtected++;
            });
            
            // Detailed explanation list per selected student
            const schoolFeedback = document.getElementById('school-feedback');
            schoolFeedback.innerHTML = '';
            const lang = gameState.currentLanguage;
            let schoolExplanationHTML = '<div style="margin-top: 1rem;"><h4>' + 
                (lang === 'en' ? 'WHO Evidence-Based Risk Assessment:' : 'WHO साक्ष्य-आधारित जोखिम मूल्यांकन:') + '</h4>';

            // Itemized analysis of the 7 protected students
            schoolExplanationHTML += '<ul style="margin-top: 0.75rem;">';
            protectedStudents.forEach(index => {
                const s = students[index];
                const priority = s.age <= 9;
                const color = priority ? '#059669' : (s.age <= 11 ? '#d97706' : '#b91c1c');
                const msgEn = priority ? '✅ Priority: under 10 - highest mortality risk' : (s.age <= 11 ? '🟡 Medium priority (age 10–11)' : '❌ Lower priority (age 12+)');
                const msgHi = priority ? '✅ प्राथमिकता: 10 वर्ष से कम - उच्चतम मृत्यु जोखिम' : (s.age <= 11 ? '🟡 मध्यम प्राथमिकता (आयु 10–11)' : '❌ कम प्राथमिकता (आयु 12+)');
                const line = lang === 'en' ? `${s.name} (Age ${s.age}) - ${msgEn}` : `${s.name} (आयु ${s.age}) - ${msgHi}`;
                schoolExplanationHTML += `<li style="margin-bottom:0.5rem;color:${color}">${line}</li>`;
            });
            schoolExplanationHTML += '</ul>';
            
            // Summary cards
            schoolExplanationHTML += '<div style="margin: 1rem 0; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid var(--hero-blue);">';
            schoolExplanationHTML += '<h5>' + (lang === 'en' ? 'Protection Priority Analysis:' : 'सुरक्षा प्राथमिकता विश्लेषण:') + '</h5>';
            schoolExplanationHTML += '<p>✅ <strong>' + (lang === 'en' ? 'High-risk students protected (age ≤9):' : 'उच्च जोखिम (आयु ≤9) संरक्षित:') + '</strong> ' + highRiskProtected + '/4</p>';
            schoolExplanationHTML += '<p>🟡 <strong>' + (lang === 'en' ? 'Medium-risk students protected (age 10-11):' : 'मध्यम जोखिम (आयु 10–11) संरक्षित:') + '</strong> ' + mediumRiskProtected + '/2</p>';
            schoolExplanationHTML += '<p>🔴 <strong>' + (lang === 'en' ? 'Low-risk students protected (age ≥12):' : 'कम जोखिम (आयु ≥12) संरक्षित:') + '</strong> ' + lowRiskProtected + '/6</p>';
            schoolExplanationHTML += '</div>';
            
            // Scoring
            let performance, points, lives;
            if (highRiskProtected >= 3) {
                performance = 'excellent'; points = 130; lives = 12;
            } else if (highRiskProtected >= 2) {
                performance = 'good'; points = 100; lives = 9;
            } else if (highRiskProtected >= 1) {
                performance = 'satisfactory'; points = 70; lives = 6;
            } else {
                performance = 'needs-improvement'; points = 40; lives = 3;
            }
            
            schoolExplanationHTML += '<div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid var(--victory-green);">';
            schoolExplanationHTML += '<h5>' + (lang === 'en' ? 'Mission Results:' : 'मिशन परिणाम:') + '</h5>';
            schoolExplanationHTML += '<p>📈 <strong>' + (lang === 'en' ? 'Knowledge Points Earned:' : 'अर्जित ज्ञान अंक:') + '</strong> ' + points + '</p>';
            schoolExplanationHTML += '<p>💚 <strong>' + (lang === 'en' ? 'Lives Protected:' : 'संरक्षित जीवन:') + '</strong> ' + lives + '</p>';
            schoolExplanationHTML += '<p>🏆 <strong>' + (lang === 'en' ? 'Performance:' : 'प्रदर्शन:') + '</strong> ' + translatePerformance(performance, lang) + '</p>';
            schoolExplanationHTML += '</div></div>';
            
            schoolFeedback.innerHTML = schoolExplanationHTML;
            schoolFeedback.classList.add('show');
            
            if (!opts.dryRun) {
                gameState.knowledgePoints += points;
                gameState.livesProtected += lives;
                updateStats();
            }
            missionSubmissions.school = true;
            
            const continueText = gameState.currentLanguage === 'en' ? '🚀 Continue to Next Mission' : '🚀 अगले मिशन पर जारी रखें';
            document.getElementById('school-submit').textContent = continueText;
            if (!opts.dryRun) setMissionCompleted('school', { skipClose: true });
            document.getElementById('school-submit').onclick = () => proceedToNextMissionFrom('school');
        }

        // MARKET MISSION
        function loadMarketMission() {
            // Stop any running game when reloading (e.g., language switch)
            if (marketGame) stopMarketGame();
            if (!preserveStateReload) selectedEducationMethods = [];

            const txt = {
                en: {
title: '🦟 Market Panic! Catch the Mosquitoes with a Net',
desc: 'You have 20 seconds. Catch 15 mosquitoes with your net to protect the community!',
                    time: 'Time', caught: 'Caught', target: 'Target', start: 'Start Game',
                    results: 'Game Results:',
                    success: 'Fantastic! You protected vendors by catching the mosquitoes!',
                    fail: 'Time up! Every mosquito you caught still helped protect lives.',
                    continue: '🚀 Continue to Next Mission'
                },
                hi: {
title: '🦟 बाज़ार में हड़कंप! जाल से मच्छरों को पकड़ो',
desc: 'आपके पास 20 सेकंड हैं। जाल से 15 मच्छरों को पकड़ें और समुदाय की रक्षा करें!',
                    time: 'समय', caught: 'पकड़े', target: 'लक्ष्य', start: 'खेल शुरू करें',
                    results: 'खेल परिणाम:',
                    success: 'कमाल! मच्छरों को पकड़कर आपने विक्रेताओं की रक्षा की!',
                    fail: 'समय समाप्त! आपने जितने मच्छर पकड़े, उतने जीवन सुरक्षित हुए।',
                    continue: '🚀 अगले मिशन पर जारी रखें'
                }
            }[gameState.currentLanguage];

            const html = `
                <div class="mission-intro">
                    <div class="npc-dialogue">
                        <div class="npc-avatar">👵</div>
                        <div class="dialogue-bubble">
<div class="npc-name">Council M.</div>
                            <p>${txt.desc}</p>
                        </div>
                    </div>
                </div>
                <div class="challenge-section">
                    <h3 class="challenge-title">${txt.title}</h3>
<div class="hud">
                        <span class="pill">⏱️ ${txt.time}: <span id="market-time">20</span>s</span>
                        <span class="pill">🦟 ${txt.caught}: <span id="market-caught">0</span></span>
                        <span class="pill">🎯 ${txt.target}: 15</span>
                        <span class="pill">🪰 ${gameState.currentLanguage==='hi'?'पकड़ो!':'Catch!'}</span>
                    </div>
                    <div class="market-game" id="market-area" aria-label="Mosquito catch game area"></div>
                    <div style="text-align:center; margin-top: 1rem;">
                        <button class="action-btn" id="market-start">${txt.start}</button>
                    </div>
                    <div class="feedback-panel" id="market-feedback"></div>
                    <button class="action-btn" id="market-submit" style="display:none">${txt.continue}</button>
<div class="learn-more" style="margin-top:1rem;">
                        <h4>📚 ${gameState.currentLanguage==='hi'?'और जानें':'Learn more'}</h4>
<div class="learn-grid">
                            <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/prevention/indoor-residual-spraying-irs" target="_blank" rel="noopener">WHO - Indoor residual spraying (IRS)</a>
                            <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/prevention/insecticide-treated-nets" target="_blank" rel="noopener">WHO - Insecticide-treated nets (ITNs)</a>
                            <a class="resource-link" href="https://www.youtube.com/watch?v=IkmjCmvfeFI" target="_blank" rel="noopener">Video - TED-Ed: The lethal mosquito</a>
                            <a class="resource-link" href="https://www.youtube.com/watch?v=sjV0JpIAH78" target="_blank" rel="noopener">Video - National Geographic: The mosquito</a>
                        </div>
                    </div>
                </div>`;

            document.getElementById('modal-content').innerHTML = html;
            normalizeLearnMoreDashes();

            // If already completed, re-render results in current language
            if (missionSubmissions.market && marketLastResult) {
                const fb = document.getElementById('market-feedback');
                const continueBtn = document.getElementById('market-submit');
                const lang = gameState.currentLanguage;
                const txt2 = lang === 'hi'
                    ? { results:'खेल परिणाम:', caught:'पकड़े गए मच्छर', perf:'प्रदर्शन', points:'अंक', lives:'संरक्षित जीवन' }
                    : { results:'Game Results:', caught:'Mosquitoes caught', perf:'Performance', points:'Points', lives:'Lives Protected' };
                if (fb) {
                    fb.innerHTML = `
                        <div style="margin-top:1rem;">
                            <h4>${txt2.results}</h4>
                            <p>🦟 ${txt2.caught}: <strong>${marketLastResult.caught}</strong>/15</p>
                            <p>🏆 ${txt2.perf}: ${translatePerformance(marketLastResult.performance, lang)}</p>
                            <p>📈 ${txt2.points}: ${marketLastResult.points}</p>
                            <p>💚 ${txt2.lives}: ${marketLastResult.lives}</p>
                        </div>`;
                    fb.classList.add('show');
                }
                if (continueBtn) {
                    continueBtn.style.display = 'block';
                    continueBtn.onclick = () => proceedToNextMissionFrom('market');
                    continueBtn.textContent = lang === 'hi' ? '🚀 अगले मिशन पर जारी रखें' : '🚀 Continue to Next Mission';
                }
                // Hide start button since game already completed
                const startBtn2 = document.getElementById('market-start');
                if (startBtn2) startBtn2.style.display = 'none';
                return;
            }

            // Wait for user to start
            const startBtn = document.getElementById('market-start');
            if (startBtn) {
                startBtn.addEventListener('click', () => {
                    startBtn.style.display = 'none';
                    startMarketGame();
                });
            }
        }

        function startMarketGame() {
            marketGame = { timerId: null, spawnId: null, remaining: 20, caught: 0, target: 15, duration: 20 };
            const timeEl = document.getElementById('market-time');
            const caughtEl = document.getElementById('market-caught');
            const area = document.getElementById('market-area');
            if (!area) return;

            // Timer
            marketGame.timerId = setInterval(() => {
                marketGame.remaining -= 1;
                if (timeEl) timeEl.textContent = marketGame.remaining;
                if (marketGame.remaining <= 0) {
                    endMarketGame(false);
                }
            }, 1000);

            // Spawner
            marketGame.spawnId = setInterval(() => {
                spawnMosquito(area);
            }, 700);

            // Click handler update
            // Click handler update
            area.addEventListener('click', (e) => {
                const target = e.target;
                if (target && target.classList && target.classList.contains('mosquito')) {
                    // Create a brief swat overlay centered on the mosquito
                    const tRect = target.getBoundingClientRect();
                    const aRect = area.getBoundingClientRect();
                    const s = document.createElement('div');
                    s.className = 'swatter swat';
                    s.style.position = 'absolute';
                    s.style.left = (tRect.left - aRect.left - 12) + 'px';
                    s.style.top = (tRect.top - aRect.top - 52) + 'px';
                    s.innerHTML = `
                        <svg viewBox="0 0 64 64" width="64" height="64" xmlns="http://www.w3.org/2000/svg" aria-label="Net Catch">
                            <!-- Net handle -->
                            <line x1="48" y1="48" x2="56" y2="56" stroke="#8B4513" stroke-width="3" stroke-linecap="round"/>
                            <!-- Net hoop -->
                            <circle cx="32" cy="32" r="16" fill="none" stroke="#666" stroke-width="2"/>
                            <!-- Net mesh pattern -->
                            <g stroke="#999" stroke-width="0.8" opacity="0.7">
                                <line x1="20" y1="28" x2="44" y2="28"/>
                                <line x1="20" y1="32" x2="44" y2="32"/>
                                <line x1="20" y1="36" x2="44" y2="36"/>
                                <line x1="28" y1="20" x2="28" y2="44"/>
                                <line x1="32" y1="20" x2="32" y2="44"/>
                                <line x1="36" y1="20" x2="36" y2="44"/>
                            </g>
                            <!-- Caught mosquito -->
                            <circle cx="32" cy="32" r="3" fill="#333"/>
                        </svg>`;
                    area.appendChild(s);
                    setTimeout(() => s.remove(), 180);

                    target.remove();
                    marketGame.caught += 1;
                    if (caughtEl) caughtEl.textContent = marketGame.caught;
                    if (marketGame.caught >= marketGame.target) {
                        endMarketGame(true);
                    }
                }
            });
        }

        function spawnMosquito(area) {
            const m = document.createElement('div');
            m.className = 'mosquito';
            m.textContent = '🦟';
            const rect = area.getBoundingClientRect();
            const x = Math.random() * (rect.width - 40);
            const y = Math.random() * (rect.height - 40);
            m.style.left = x + 'px';
            m.style.top = y + 'px';
            area.appendChild(m);
            // Auto-remove after 1.5s to keep things moving
            setTimeout(() => { if (m && m.parentNode) m.remove(); }, 1500);
        }

        function stopMarketGame() {
            const area = document.getElementById('market-area');
            if (marketGame?.timerId) clearInterval(marketGame.timerId);
            if (marketGame?.spawnId) clearInterval(marketGame.spawnId);
            if (area) area.innerHTML = '';
            marketGame = null;
        }

        function endMarketGame(victory) {
            if (!marketGame) return;
            const caught = marketGame.caught;
            stopMarketGame();

            // Scoring
            let performance, points, lives;
            if (caught >= 15) { performance = 'excellent'; points = 150; lives = 15; }
            else if (caught >= 10) { performance = 'good'; points = 100; lives = 10; }
            else if (caught >= 5) { performance = 'satisfactory'; points = 60; lives = 6; }
            else { performance = 'needs-improvement'; points = 30; lives = 3; }

            gameState.knowledgePoints += points;
            gameState.livesProtected += lives;
            updateStats();

            const lang = gameState.currentLanguage;
            const txt = lang === 'hi'
                ? { results:'खेल परिणाम:', caught:'पकड़े गए मच्छर', perf:'प्रदर्शन', points:'अंक', lives:'संरक्षित जीवन' }
                : { results:'Game Results:', caught:'Mosquitoes caught', perf:'Performance', points:'Points', lives:'Lives Protected' };

            const fb = document.getElementById('market-feedback');
            if (fb) {
                fb.innerHTML = `
                    <div style="margin-top:1rem;">
                        <h4>${txt.results}</h4>
                        <p>🦟 ${txt.caught}: <strong>${caught}</strong>/15</p>
                        <p>🏆 ${txt.perf}: ${translatePerformance(performance, lang)}</p>
                        <p>📈 ${txt.points}: ${points}</p>
                        <p>💚 ${txt.lives}: ${lives}</p>
                    </div>`;
                fb.classList.add('show');
            }

            // Save for re-render on language switch
            missionSubmissions.market = true;
            marketLastResult = { caught, performance, points, lives };
            saveProgress();

            const continueBtn = document.getElementById('market-submit');
            if (continueBtn) {
                continueBtn.style.display = 'block';
                // Mark mission complete but keep modal open
                setMissionCompleted('market', { skipClose: true });
                continueBtn.onclick = () => proceedToNextMissionFrom('market');
                continueBtn.textContent = lang === 'hi' ? '🚀 अगले मिशन पर जारी रखें' : '🚀 Continue to Next Mission';
            }
        }

        // Re-apply in-progress selections after mission content reload (e.g., language switch)
        function reapplyMissionSelections() {
            const mission = gameState.currentMission;
            if (!mission) return;
            if (mission === 'clinic') {
                // Re-mark selected symptoms and enable submit if needed
                selectedSymptoms.forEach(id => {
                    const card = document.querySelector(`[data-symptom=\"${id}\"]`);
                    if (card) card.classList.add('selected');
                });
                const submit = document.getElementById('clinic-submit');
                if (submit) submit.disabled = selectedSymptoms.length === 0;
                // If already submitted, regenerate feedback in current language without changing scores
                if (missionSubmissions.clinic) evaluateClinicDiagnosis({ dryRun: true });
            } else if (mission === 'school') {
                // Re-mark protected students and enforce capacity
                protectedStudents.forEach(idx => {
                    const card = document.querySelector(`[data-student=\"${idx}\"]`);
                    if (card) card.classList.add('protected');
                });
                const submit = document.getElementById('school-submit');
                if (submit) submit.disabled = protectedStudents.length !== 7;
                if (missionSubmissions.school) evaluateSchoolProtection({ dryRun: true });
            } else if (mission === 'market') {
                // If results exist, re-render them; otherwise nothing to re-apply
                if (missionSubmissions.market && marketLastResult) {
                    const fb = document.getElementById('market-feedback');
                    const continueBtn = document.getElementById('market-submit');
                    const lang = gameState.currentLanguage;
                    const txt2 = lang === 'hi'
                        ? { results:'खेल परिणाम:', caught:'पकड़े गए मच्छर', perf:'प्रदर्शन', points:'अंक', lives:'संरक्षित जीवन' }
                        : { results:'Game Results:', caught:'Mosquitoes caught', perf:'Performance', points:'Points', lives:'Lives Protected' };
                    if (fb) {
                        fb.innerHTML = `
                            <div style=\"margin-top:1rem;\">
                                <h4>${txt2.results}</h4>
                                <p>🦟 ${txt2.caught}: <strong>${marketLastResult.caught}</strong>/15</p>
                                <p>🏆 ${txt2.perf}: ${translatePerformance(marketLastResult.performance, lang)}</p>
                                <p>📈 ${txt2.points}: ${marketLastResult.points}</p>
                                <p>💚 ${txt2.lives}: ${marketLastResult.lives}</p>
                            </div>`;
                        fb.classList.add('show');
                    }
                    if (continueBtn) {
                        continueBtn.style.display = 'block';
                        continueBtn.onclick = () => proceedToNextMissionFrom('market');
                        continueBtn.textContent = lang === 'hi' ? '🚀 अगले मिशन पर जारी रखें' : '🚀 Continue to Next Mission';
                    }
                }
            } else if (mission === 'homes') {
                // Re-mark found breeding sites, counters, help panel, and enable submit if threshold reached
                const sites = Array.from(document.querySelectorAll('.compound-container .breeding-site'));
                if (sites && sites.length) {
                    sites.forEach(el => {
                        const handler = el.getAttribute('onclick') || '';
                        foundBreedingSites.forEach(id => {
                            if (handler.includes(`'${id}', true`)) {
                                el.classList.add('correct');
                            }
                        });
                    });
                }
                const found = foundBreedingSites.length;
                const foundEl = document.getElementById('sites-found');
                if (foundEl) foundEl.textContent = found;
                const scoreEl = document.getElementById('current-score');
                if (scoreEl) scoreEl.textContent = found * 10;
                const help = document.getElementById('breeding-help');
                if (help && breedingHelpShown) help.classList.add('show');
                const submit = document.getElementById('homes-submit');
                if (submit) submit.disabled = found < 6;
                if (missionSubmissions.homes && typeof evaluateVectorControl === 'function') evaluateVectorControl({ dryRun: true });
            }
        }

        // Toggle education method selection
        function toggleEducationMethod(methodId) {
            const methodCard = document.querySelector(`[data-method="${methodId}"]`);
            
            if (selectedEducationMethods.includes(methodId)) {
                selectedEducationMethods = selectedEducationMethods.filter(m => m !== methodId);
                methodCard.classList.remove('selected');
            } else {
                selectedEducationMethods.push(methodId);
                methodCard.classList.add('selected');
            }
            
            document.getElementById('market-submit').disabled = selectedEducationMethods.length === 0;
            saveProgress();
        }

        // Evaluate health education
        function evaluateHealthEducation() {
            const correctMethods = ['demonstrations', 'visual-aids', 'community-sessions', 'peer-education'];
            const incorrectMethods = ['fear-tactics', 'blame-approach', 'expensive-solutions', 'ignore-culture'];
            
            let correctCount = 0;
            let incorrectCount = 0;
            
            selectedEducationMethods.forEach(methodId => {
                const methodCard = document.querySelector(`[data-method="${methodId}"]`);
                if (correctMethods.includes(methodId)) {
                    methodCard.classList.add('correct');
                    correctCount++;
                } else {
                    methodCard.classList.add('incorrect');
                    incorrectCount++;
                }
            });
            
            // Calculate performance and scoring
            let performance, points, lives;
            
            if (correctCount >= 3 && incorrectCount === 0) {
                performance = 'excellent';
                points = 120;
                lives = 15;
            } else if (correctCount >= 2) {
                performance = 'good';
                points = 90;
                lives = 10;
            } else if (correctCount >= 1) {
                performance = 'satisfactory';
                points = 60;
                lives = 6;
            } else {
                performance = 'needs-improvement';
                points = 30;
                lives = 3;
            }
            
            gameState.knowledgePoints += points;
            gameState.livesProtected += lives;
            updateStats();
            
            // WHO explanations for methods (full answer key)
            const methodExplanations = {
                en: {
                    demonstrations: '✅ Live demonstrations improve skill retention and behavior change in community settings.',
                    'visual-aids': '✅ Visual aids help low-literacy audiences grasp prevention steps accurately.',
                    'community-sessions': '✅ Community sessions build trust and collective efficacy for prevention.',
                    'peer-education': '✅ Peer educators increase credibility and adoption of behaviors.',
                    'fear-tactics': '❌ Fear messaging backfires; increases avoidance and reduces help-seeking.',
                    'blame-approach': '❌ Blaming creates stigma; erodes trust and program effectiveness.',
                    'expensive-solutions': '❌ Costly-only strategies exclude vulnerable households; harms equity.',
                    'ignore-culture': '❌ Ignoring beliefs reduces message acceptance and sustained change.'
                },
                hi: {
                    demonstrations: '✅ प्रत्यक्ष प्रदर्शन कौशल प्रतिधारण और व्यवहार परिवर्तन को बढ़ाते हैं।',
                    'visual-aids': '✅ दृश्य सहायक सामग्री कम साक्षरता में भी सही समझ बनाने में मदद करती है।',
                    'community-sessions': '✅ सामुदायिक सत्र विश्वास और सामूहिक क्षमता बनाते हैं।',
                    'peer-education': '✅ साथी शिक्षक संदेश की विश्वसनीयता और अपनाने को बढ़ाते हैं।',
                    'fear-tactics': '❌ डर आधारित संदेश उल्टा असर करते हैं; लोग उपचार से बचते हैं।',
                    'blame-approach': '❌ दोषारोपण कलंक बढ़ाता है और विश्वास को नुकसान पहुंचाता है।',
                    'expensive-solutions': '❌ केवल महंगी विधियां कमजोर परिवारों को बाहर करती हैं।',
                    'ignore-culture': '❌ स्थानीय मान्यताओं की अनदेखी से संदेश स्वीकार्यता कम होती है।'
                }
            };

            const marketFeedback = document.getElementById('market-feedback');
            const lang = gameState.currentLanguage;
            let marketExplanationHTML = '<div style="margin-top: 1rem;"><h4>' + 
                (lang === 'en' ? 'WHO Evidence-Based Health Communication Analysis:' : 'WHO साक्ष्य-आधारित स्वास्थ्य संचार विश्लेषण:') + '</h4>';

            // Mark missed correct methods
            correctMethods.forEach(m => {
                if (!selectedEducationMethods.includes(m)) {
                    const card = document.querySelector(`[data-method="${m}"]`);
                    if (card) card.classList.add('missed');
                }
            });

            // Full answer key: correct and incorrect (shows selected state)
            marketExplanationHTML += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;margin-top:0.75rem;">';

            const allMethods = [...correctMethods, ...incorrectMethods];
            const groups = [
                { titleEn: 'Correct methods (WHO)', titleHi: 'सही विधियां (WHO)', list: correctMethods, color: '#059669' },
                { titleEn: 'Incorrect methods (WHO)', titleHi: 'गलत विधियां (WHO)', list: incorrectMethods, color: '#b91c1c' }
            ];
            groups.forEach(g => {
                marketExplanationHTML += `<div style="border-left:4px solid ${g.color};background:#f8fafc;border-radius:8px;padding:0.75rem;">`;
                marketExplanationHTML += `<h5 style="margin:0 0 .5rem 0;color:${g.color}">${lang==='en'?g.titleEn:g.titleHi}</h5>`;
                marketExplanationHTML += '<ul style="margin-left:1rem">';
                g.list.forEach(id => {
                    const selected = selectedEducationMethods.includes(id);
                    const tag = selected ? (lang==='en'?'Selected':'चुना हुआ') : (lang==='en'?'Not selected':'नहीं चुना');
                    const msg = methodExplanations[lang][id] || id;
                    marketExplanationHTML += `<li style="margin-bottom:0.4rem;color:${g.color}">${msg} <span style="color:#64748b">(${tag})</span></li>`;
                });
                marketExplanationHTML += '</ul></div>';
            });
            marketExplanationHTML += '</div>';
            
            // Final scoring display
            marketExplanationHTML += '<div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid var(--victory-green);">';
            marketExplanationHTML += '<h5>' + (lang === 'en' ? 'Mission Results:' : 'मिशन परिणाम:') + '</h5>';
            marketExplanationHTML += '<p>📈 <strong>' + (lang === 'en' ? 'Knowledge Points Earned:' : 'अर्जित ज्ञान अंक:') + '</strong> ' + points + '</p>';
            marketExplanationHTML += '<p>💚 <strong>' + (lang === 'en' ? 'Lives Protected:' : 'संरक्षित जीवन:') + '</strong> ' + lives + '</p>';
            marketExplanationHTML += '<p>🏆 <strong>' + (lang === 'en' ? 'Performance:' : 'प्रदर्शन:') + '</strong> ' + translatePerformance(performance, lang) + '</p>';
            marketExplanationHTML += '</div></div>';
            
            marketFeedback.innerHTML = marketExplanationHTML;
            marketFeedback.classList.add('show');
            
            // Update submit button
            const continueText = gameState.currentLanguage === 'en' ? '🚀 Continue to Next Mission' : '🚀 अगले मिशन पर जारी रखें';
            document.getElementById('market-submit').textContent = continueText;
            document.getElementById('market-submit').onclick = () => proceedToNextMissionFrom('market');
        }

        // HOMES MISSION - MOSQUITO BREEDING GAME
        function loadHomesMission() {
            if (!preserveStateReload) {
                foundBreedingSites = [];
                breedingHelpShown = false; // Reset help shown flag for this mission
                breedingAttempts = 0; // Reset attempts counter
            }
            
            const content = {
                en: `
                    <div class="mission-intro">
                        <div class="npc-dialogue">
                            <div class="npc-avatar">👨‍👩‍👧‍👦</div>
                            <div class="dialogue-bubble">
<div class="npc-name">Family M.</div>
                                <p>"Our daughter has developed malaria symptoms, and we keep getting bitten by mosquitoes every night! We suspect they're breeding somewhere around our compound. Please help us identify where the mosquitoes are reproducing so we can eliminate these deadly breeding sites."</p>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-section">
                        <h3 class="challenge-title">🦟 Vector Control Challenge</h3>
                        <p class="challenge-description"><strong>Mission:</strong> Find exactly 6 mosquito breeding sites out of 12 locations. Use your scientific knowledge to identify where mosquitoes breed! Remember: mosquitoes need standing water for 7-14 days to breed!</p>
                        
                        <div class="breeding-progress">
                            <div class="progress-item">
                                <span class="progress-number found" id="sites-found">0</span>
                                <div class="progress-label">Sites Found</div>
                            </div>
                            <div class="progress-item">
                                <span class="progress-number target">6</span>
                                <div class="progress-label">Target Sites</div>
                            </div>
                            <div class="progress-item">
                                <span class="progress-number score" id="current-score">0</span>
                                <div class="progress-label">Score</div>
                            </div>
                        </div>

                        <div class="compound-container">
                            <div class="compound-title">🏠 Family Compound</div>
                            
                            <!-- Correct breeding sites -->
                            <div class="breeding-site site-1" onclick="checkBreedingSite(event, 'water-barrel', true)" title="Water barrel with standing water" aria-label="Water barrel with standing water">🪣</div>
                            <div class="breeding-site site-2" onclick="checkBreedingSite(event, 'plant-saucers', true)" title="Plant saucers holding water" aria-label="Plant saucers holding water">🪴</div>
<div class="breeding-site site-3" onclick="checkBreedingSite(event, 'roof-gutter', true)" title="Blocked open drain with stagnant dirty water" aria-label="Blocked open drain with stagnant dirty water" data-tip="Open drain - stagnant, dirty water">
    <svg class="gutter-icon" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg" aria-label="Open drain">
        <!-- Concrete edges -->
        <rect x="6" y="22" width="68" height="24" rx="5" fill="#6b7280"/>
        <rect x="8" y="26" width="64" height="16" rx="3" fill="#4b5563"/>
        <!-- Murky water -->
        <rect x="10" y="30" width="60" height="8" rx="2" fill="#315a49"/>
        <path d="M12 34 C 24 28 40 40 68 33" stroke="#86a98f" stroke-width="2" opacity="0.6" fill="none"/>
        <!-- Debris / leaves -->
        <circle cx="20" cy="34" r="2" fill="#b45309"/>
        <rect x="32" y="33" width="4" height="2" fill="#9ca3af" transform="rotate(15 34 34)"/>
        <path d="M52 33 l4 2 -4 2 z" fill="#84cc16"/>
    </svg>
</div>
                            <div class="breeding-site site-4" onclick="checkBreedingSite(event, 'old-bucket', true)" title="Abandoned bucket holding rainwater" aria-label="Abandoned bucket holding rainwater">🪣</div>
                            <div class="breeding-site site-5" onclick="checkBreedingSite(event, 'flower-vase', true)" title="Flower vase water" aria-label="Flower vase water">🏺</div>
<div class="breeding-site site-6 tires" onclick="checkBreedingSite(event, 'tire-planter', true)" title="Old tires collecting rainwater" aria-label="Old tires collecting rainwater" data-tip="Old tires - collect rainwater">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg" aria-label="Stacked tires">
        <circle cx="32" cy="48" r="16" fill="#111827" stroke="#6b7280" stroke-width="3"/>
        <circle cx="48" cy="32" r="16" fill="#111827" stroke="#6b7280" stroke-width="3"/>
        <circle cx="32" cy="48" r="6" fill="#374151"/>
        <circle cx="48" cy="32" r="6" fill="#374151"/>
    </svg>
</div>
                            
                            <!-- Incorrect sites -->
<div class="breeding-site site-7" onclick="checkBreedingSite(event, 'tree-base', false)" title="Dry tree base (no water)" aria-label="Dry tree base (no water)" data-tip="Tree base - dry, no water">🌳</div>
<div class="breeding-site site-8" onclick="checkBreedingSite(event, 'dry-garden', false)" title="Dry garden soil (no standing water)" aria-label="Dry garden soil (no standing water)" data-tip="Dry garden - no standing water">🌿</div>
<div class="breeding-site site-9" onclick="checkBreedingSite(event, 'house-wall', false)" title="House wall (no water retention)" aria-label="House wall (no water retention)" data-tip="Wall - no water retention">🧱</div>
<div class="breeding-site site-10" onclick="checkBreedingSite(event, 'flowing-drain', false)" title="Flowing drain (larvae get flushed)" aria-label="Flowing drain (larvae get flushed)" data-tip="Flowing drain - larvae washed away">🌊</div>
<div class="breeding-site site-11" onclick="checkBreedingSite(event, 'solid-pavement', false)" title="Solid pavement (no water retention)" aria-label="Solid pavement (no water retention)" data-tip="Pavement - no water retention">🪨</div>
<div class="breeding-site site-12" onclick="checkBreedingSite(event, 'hanging-clothes', false)" title="Hanging clothes (no water)" aria-label="Hanging clothes (no water)" data-tip="Clothes - no water">👕</div>
                        </div>

                        <div class="help-panel" id="breeding-help">
                            <div class="help-title">🔬 Scientific Guidance</div>
                            <p><strong>Mosquito Biology:</strong> Female Anopheles mosquitoes need clean, standing water that remains undisturbed for 7-14 days to complete their life cycle. Look for containers, puddles, or blocked drainage that can hold water for extended periods.</p>
                            <p><strong>Key Signs:</strong> Water storage containers, flower pot saucers, blocked gutters, abandoned buckets, tire planters with collected water.</p>
                            <p><strong>Not Breeding Sites:</strong> Dry surfaces, flowing water, solid objects without water retention, well-drained areas.</p>
                        </div>
                        
                        <div class="feedback-panel" id="homes-feedback"></div>
                        <button class="action-btn" id="homes-submit" onclick="evaluateVectorControl()" disabled>🏠 Complete Vector Control</button>
<div class="learn-more" style="margin-top:1rem;">
                            <h4>📚 Learn more</h4>
<div class="learn-grid">
                                <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/prevention/larval-source-management" target="_blank" rel="noopener">WHO - Larval source management (LSM)</a>
                                <a class="resource-link" href="https://www.pbslearningmedia.org/resource/envh10.sci.life.eco.malaria/malaria-treatment-and-prevention-strategies/" target="_blank" rel="noopener">PBS LearningMedia - Malaria prevention strategies</a>
                                <a class="resource-link" href="https://www.youtube.com/watch?v=rIiegij3DQs" target="_blank" rel="noopener">Video - WEHI/Drew Berry: Malaria lifecycle</a>
                                <a class="resource-link" href="https://www.cdc.gov/malaria/about/index.html" target="_blank" rel="noopener">CDC - Malaria (about, symptoms)</a>
                            </div>
                        </div>
                    </div>
                `,
                hi: `
                    <div class="mission-intro">
                        <div class="npc-dialogue">
                            <div class="npc-avatar">👨‍👩‍👧‍👦</div>
                            <div class="dialogue-bubble">
<div class="npc-name">परिवार एम.</div>
                                <p>"हमारी बेटी में मलेरिया के लक्षण विकसित हो गए हैं, और हमें हर रात मच्छरों के काटने का सामना करना पड़ता है! हमें संदेह है कि वे हमारे परिसर के आसपास कहीं प्रजनन कर रहे हैं। कृपया हमारी सहायता करें यह पहचानने में कि मच्छर कहाँ प्रजनन कर रहे हैं ताकि हम इन घातक प्रजनन स्थलों को समाप्त कर सकें।"</p>
                            </div>
                        </div>
                    </div>

                    <div class="challenge-section">
                        <h3 class="challenge-title">🦟 वेक्टर नियंत्रण चुनौती</h3>
                        <p class="challenge-description"><strong>मिशन:</strong> 12 स्थानों में से ठीक 6 मच्छर प्रजनन स्थलों की पहचान करें। अपने वैज्ञानिक ज्ञान का उपयोग करके बताएं कि मच्छर कहाँ प्रजनन करते हैं! याद रखें: मच्छरों को प्रजनन के लिए 7-14 दिनों तक स्थिर पानी की आवश्यकता होती है!</p>
                        
                        <div class="breeding-progress">
                            <div class="progress-item">
                                <span class="progress-number found" id="sites-found">0</span>
                                <div class="progress-label">मिले स्थल</div>
                            </div>
                            <div class="progress-item">
                                <span class="progress-number target">6</span>
                                <div class="progress-label">लक्ष्य स्थल</div>
                            </div>
                            <div class="progress-item">
                                <span class="progress-number score" id="current-score">0</span>
                                <div class="progress-label">स्कोर</div>
                            </div>
                        </div>

                        <div class="compound-container">
                            <div class="compound-title">🏠 परिवार परिसर</div>
                            
                            <!-- Correct breeding sites -->
<div class="breeding-site site-1" onclick="checkBreedingSite(event, 'water-barrel', true)" title="पानी से भरी बाल्टी/ड्रम" aria-label="पानी से भरी बाल्टी/ड्रम" data-tip="बाल्टी - ठहरा पानी">🪣</div>
<div class="breeding-site site-2" onclick="checkBreedingSite(event, 'plant-saucers', true)" title="गमलों की तश्तरी में ठहरा पानी" aria-label="गमलों की तश्तरी में ठहरा पानी" data-tip="तश्तरी - पानी जमा">🪴</div>
<div class="breeding-site site-3" onclick="checkBreedingSite(event, 'roof-gutter', true)" title="खुली नाली में ठहरा, गंदा पानी" aria-label="खुली नाली में ठहरा, गंदा पानी" data-tip="खुली नाली - ठहरा पानी, गंदगी">
    <svg class="gutter-icon" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg" aria-label="Open drain">
        <rect x="6" y="22" width="68" height="24" rx="5" fill="#6b7280"/>
        <rect x="8" y="26" width="64" height="16" rx="3" fill="#4b5563"/>
        <rect x="10" y="30" width="60" height="8" rx="2" fill="#315a49"/>
        <path d="M12 34 C 24 28 40 40 68 33" stroke="#86a98f" stroke-width="2" opacity="0.6" fill="none"/>
        <circle cx="20" cy="34" r="2" fill="#b45309"/>
        <rect x="32" y="33" width="4" height="2" fill="#9ca3af" transform="rotate(15 34 34)"/>
        <path d="M52 33 l4 2 -4 2 z" fill="#84cc16"/>
    </svg>
</div>
<div class="breeding-site site-4" onclick="checkBreedingSite(event, 'old-bucket', true)" title="बरसाती पानी भरी पुरानी बाल्टी" aria-label="बरसाती पानी भरी पुरानी बाल्टी" data-tip="पुरानी बाल्टी - बारिश का पानी">🪣</div>
<div class="breeding-site site-5" onclick="checkBreedingSite(event, 'flower-vase', true)" title="फूलदान का पानी" aria-label="फूलदान का पानी" data-tip="फूलदान - ठहरा पानी">🏺</div>
<div class="breeding-site site-6 tires" onclick="checkBreedingSite(event, 'tire-planter', true)" title="टायरों में जमा बारिश का पानी" aria-label="टायरों में जमा बारिश का पानी" data-tip="टायर - पानी जमा">
    <svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg" aria-label="Stacked tires">
        <circle cx="32" cy="48" r="16" fill="#111827" stroke="#6b7280" stroke-width="3"/>
        <circle cx="48" cy="32" r="16" fill="#111827" stroke="#6b7280" stroke-width="3"/>
        <circle cx="32" cy="48" r="6" fill="#374151"/>
        <circle cx="48" cy="32" r="6" fill="#374151"/>
    </svg>
</div>
                            
                            <!-- Incorrect sites -->
<div class="breeding-site site-7" onclick="checkBreedingSite(event, 'tree-base', false)" title="पेड़ का सूखा आधार (पानी नहीं)" aria-label="पेड़ का सूखा आधार (पानी नहीं)" data-tip="पेड़ का आधार - सूखा">🌳</div>
<div class="breeding-site site-8" onclick="checkBreedingSite(event, 'dry-garden', false)" title="सूखी क्यारी/मिट्टी (ठहरा पानी नहीं)" aria-label="सूखी क्यारी/मिट्टी (ठहरा पानी नहीं)" data-tip="सूखी क्यारी - पानी नहीं">🌿</div>
<div class="breeding-site site-9" onclick="checkBreedingSite(event, 'house-wall', false)" title="दीवार (पानी नहीं ठहरता)" aria-label="दीवार (पानी नहीं ठहरता)" data-tip="दीवार - पानी नहीं">🧱</div>
<div class="breeding-site site-10" onclick="checkBreedingSite(event, 'flowing-drain', false)" title="बहता नाला (लार्वा बह जाते हैं)" aria-label="बहता नाला (लार्वा बह जाते हैं)" data-tip="बहता नाला - लार्वा बहते हैं">🌊</div>
<div class="breeding-site site-11" onclick="checkBreedingSite(event, 'solid-pavement', false)" title="ठोस फर्श (पानी नहीं ठहरता)" aria-label="ठोस फर्श (पानी नहीं ठहरता)" data-tip="ठोस फर्श - पानी नहीं">🪨</div>
<div class="breeding-site site-12" onclick="checkBreedingSite(event, 'hanging-clothes', false)" title="टंगे हुए कपड़े (पानी नहीं)" aria-label="टंगे हुए कपड़े (पानी नहीं)" data-tip="कपड़े - पानी नहीं">👕</div>
                        </div>

                        <div class="help-panel" id="breeding-help">
                            <div class="help-title">🔬 वैज्ञानिक मार्गदर्शन</div>
                            <p><strong>मच्छर जीव विज्ञान:</strong> मादा एनोफिलीज मच्छरों को अपना जीवन चक्र पूरा करने के लिए साफ, स्थिर पानी की आवश्यकता होती है जो 7-14 दिनों तक अबाधित रहे। ऐसे पात्र, गड्ढे, या अवरुद्ध नालियों को देखें जो लंबे समय तक पानी धारण कर सकते हैं।</p>
                            <p><strong>मुख्य संकेत:</strong> जल भंडारण कंटेनर, फूलों के गमलों की तश्तरी, अवरुद्ध नालियां, परित्यक्त बाल्टियां, जल संग्रहित टायर प्लांटर।</p>
                            <p><strong>प्रजनन स्थल नहीं:</strong> सूखी सतहें, बहता पानी, जल धारण के बिना ठोस वस्तुएं, अच्छी जल निकासी वाले क्षेत्र।</p>
                        </div>
                        
                        <div class="feedback-panel" id="homes-feedback"></div>
                        <button class="action-btn" id="homes-submit" onclick="evaluateVectorControl()" disabled>🏠 वेक्टर नियंत्रण पूरा करें</button>
<div class="learn-more" style="margin-top:1rem;">
                            <h4>📚 और जानें</h4>
<div class="learn-grid">
                                <a class="resource-link" href="https://www.who.int/teams/global-malaria-programme/prevention/larval-source-management" target="_blank" rel="noopener">WHO - Larval source management (LSM)</a>
                                <a class="resource-link" href="https://www.pbslearningmedia.org/resource/envh10.sci.life.eco.malaria/malaria-treatment-and-prevention-strategies/" target="_blank" rel="noopener">PBS LearningMedia - Malaria prevention strategies</a>
                                <a class="resource-link" href="https://www.youtube.com/watch?v=rIiegij3DQs" target="_blank" rel="noopener">Video - WEHI/Drew Berry: Malaria lifecycle</a>
                                <a class="resource-link" href="https://www.cdc.gov/malaria/about/index.html" target="_blank" rel="noopener">CDC - Malaria (about, symptoms)</a>
                            </div>
                        </div>
                    </div>
                `
            };
            
            document.getElementById('modal-content').innerHTML = content[gameState.currentLanguage];
            normalizeLearnMoreDashes();
            // Randomize breeding site positions so correct sites are not clustered
            randomizeBreedingSitesPositions();
        }

        // Sound effects
        function playSound(type) {
            if (!sfxEnabled) return;
            // Create audio context for sound effects
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === 'correct') {
                // Play success sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } else if (type === 'incorrect') {
                // Play error sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } else if (type === 'complete') {
                // Play completion sound
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.4);
                oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.6);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            }
        }

        // Particle effects
        function createParticles(x, y, count = 5) {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.left = (x + (Math.random() - 0.5) * 20) + 'px';
                particle.style.top = (y + (Math.random() - 0.5) * 20) + 'px';
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    particle.remove();
                }, 2000);
            }
        }

        // Celebration confetti
        function createCelebration() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            document.body.appendChild(celebration);
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                celebration.appendChild(confetti);
            }
            
            setTimeout(() => {
                celebration.remove();
            }, 5000);
        }

        // Add hint pulse on remaining correct sites for a short time
        function hintCorrectSites() {
            const correctSites = ['water-barrel','plant-saucers','roof-gutter','old-bucket','flower-vase','tire-planter'];
            const elements = Array.from(document.querySelectorAll('.breeding-site'));
            elements.forEach(el => {
                const handler = el.getAttribute('onclick') || '';
                const isCorrect = /true\)\)$/.test(handler);
                if (isCorrect && !el.classList.contains('correct')) el.classList.add('hint');
            });
            setTimeout(() => { elements.forEach(el => el.classList.remove('hint')); }, 3000);
        }

        // Distribute breeding sites randomly within the compound to avoid clustering
        function randomizeBreedingSitesPositions() {
            const container = document.querySelector('.compound-container');
            if (!container) return;
            const sites = Array.from(container.querySelectorAll('.breeding-site'));
            if (sites.length !== 12) return;

            // Predefined diverse positions (percentages) spread across the area
            const positions = [
                {top: '12%', left: '10%'}, {top: '12%', left: '33%'}, {top: '12%', left: '66%'}, {top: '20%', left: '80%'},
                {top: '38%', left: '15%'}, {top: '42%', left: '45%'}, {top: '40%', left: '72%'}, {top: '55%', left: '28%'},
                {top: '66%', left: '10%'}, {top: '70%', left: '36%'}, {top: '72%', left: '58%'}, {top: '78%', left: '78%'}
            ];
            // Shuffle positions
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }
            // Assign inline styles to override CSS class positions
            sites.forEach((el, idx) => {
                el.style.top = positions[idx].top;
                el.style.left = positions[idx].left;
            });
        }

        // Check breeding site - show immediate explanation on click
        function checkBreedingSite(evt, siteId, isCorrect) {
            const siteElement = evt.currentTarget;

            if (siteElement.classList.contains('correct') || siteElement.classList.contains('incorrect')) {
                return;
            }

            // Increment attempts counter
            breedingAttempts++;

            if (isCorrect) {
                siteElement.classList.add('correct');
                foundBreedingSites.push(siteId);
                document.getElementById('sites-found').textContent = foundBreedingSites.length;

                // Success sound and particles
                playSound('correct');
                const rect = siteElement.getBoundingClientRect();
                createParticles(rect.left + rect.width/2, rect.top + rect.height/2, 8);

                // Immediate explanation
                const lang = gameState.currentLanguage;
                const msg = (breedingExplanations[siteId]?.correct?.[lang]) || (lang==='hi' ? 'सही: यहां पानी ठहर सकता है।' : 'Correct: this retains standing water.');
                showExplanation(siteElement, `✅ ${msg}`, 'success');

                // Update score
                const currentScore = foundBreedingSites.length * 10;
                document.getElementById('current-score').textContent = currentScore;

                if (foundBreedingSites.length >= 6) {
                    document.getElementById('homes-submit').disabled = false;
                    playSound('complete');
                    createCelebration();
                }
            } else {
                siteElement.classList.add('incorrect');
                playSound('incorrect');

                // Immediate explanation
                const lang = gameState.currentLanguage;
                const msg = (breedingExplanations[siteId]?.wrong?.[lang]) || (lang==='hi' ? 'प्रजनन स्थल नहीं: यहां स्थिर पानी नहीं है।' : 'Not a breeding site: no standing water present.');
                showExplanation(siteElement, `❌ ${msg}`, 'error');

                // Reveal help panel on first mistake
            if (!breedingHelpShown) {
                    document.getElementById('breeding-help').classList.add('show');
                    breedingHelpShown = true;
                    hintCorrectSites();
                }
            }
            saveProgress();
        }

        // Evaluate vector control
        function evaluateVectorControl(opts = {}) {
            let performance, points, lives;
            
            // Calculate base points based on sites found
            let basePoints = 0;
            let baseLives = 0;
            
            if (foundBreedingSites.length >= 6) {
                performance = 'excellent';
                basePoints = 300;
                baseLives = 20;
            } else if (foundBreedingSites.length >= 5) {
                performance = 'good';
                basePoints = 200;
                baseLives = 15;
            } else if (foundBreedingSites.length >= 4) {
                performance = 'satisfactory';
                basePoints = 150;
                baseLives = 10;
            } else {
                performance = 'needs-improvement';
                basePoints = 100;
                baseLives = 5;
            }
            
            // Apply penalty for too many attempts
            let attemptPenalty = 0;
            if (breedingAttempts > 12) {
                attemptPenalty = Math.floor((breedingAttempts - 12) * 5); // 5 points penalty per extra attempt
                performance = 'needs-improvement'; // Downgrade performance if too many attempts
            } else if (breedingAttempts > 8) {
                attemptPenalty = Math.floor((breedingAttempts - 8) * 3); // 3 points penalty per extra attempt
                if (performance === 'excellent') performance = 'good';
            }
            
            // Calculate final points and lives
            points = Math.max(0, basePoints - attemptPenalty);
            lives = Math.max(1, baseLives - Math.floor(attemptPenalty / 10)); // Reduce lives based on penalty
            
            if (!opts.dryRun) {
                gameState.knowledgePoints += points;
                gameState.livesProtected += lives;
                updateStats();
            }
            
            const homesFeedback = document.getElementById('homes-feedback');
            const lang = gameState.currentLanguage;
            homesFeedback.innerHTML = `
                <div style="margin-top: 1rem;">
                    <h4>${lang === 'en' ? 'Mosquito Breeding Game Results:' : 'मच्छर प्रजनन खेल परिणाम:'}</h4>
                    <p>✅ ${lang === 'en' ? 'Breeding sites found:' : 'प्रजनन स्थल मिले:'} ${foundBreedingSites.length}/6</p>
                    <p>🎯 ${lang === 'en' ? 'Total attempts:' : 'कुल प्रयास:'} ${breedingAttempts}</p>
                    <p>🏆 ${lang === 'en' ? 'Performance:' : 'प्रदर्शन:'} ${translatePerformance(performance, lang)}</p>
                    <p>📈 ${lang === 'en' ? 'Points earned:' : 'अर्जित अंक:'} ${points} ${attemptPenalty > 0 ? `(${lang === 'en' ? 'penalty applied' : 'जुर्माना लगाया गया'})` : ''}</p>
                    <p>💚 ${lang === 'en' ? 'Lives protected:' : 'संरक्षित जीवन:'} ${lives}</p>
                </div>
            `;
            homesFeedback.classList.add('show');
            
            const completeText = gameState.currentLanguage === 'en' ? '🏁 End Mission' : '🏁 मिशन समाप्त';
            document.getElementById('homes-submit').textContent = completeText;
            // Mark as complete but keep modal open so closing with X still unlocks next
            if (!opts.dryRun) setMissionCompleted('homes', { skipClose: true });
            document.getElementById('homes-submit').onclick = () => completeMission('homes');
            missionSubmissions.homes = true;
        }

        // Badges
        const BADGES = {
            clinic: { id: 'clinic_ace', icon: '🩺', en: 'Clinic Ace', hi: 'क्लिनिक ऐस', descEn: 'Completed the clinic mission', descHi: 'क्लिनिक मिशन पूरा किया' },
            school: { id: 'school_protector', icon: '🛡️', en: 'School Protector', hi: 'विद्यालय संरक्षक', descEn: 'Protected students wisely', descHi: 'छात्रों की समझदारी से सुरक्षा की' },
            market: { id: 'market_mentor', icon: '🗣️', en: 'Market Mentor', hi: 'बाज़ार मार्गदर्शक', descEn: 'Led effective health education', descHi: 'प्रभावी स्वास्थ्य शिक्षा चलाई' },
            homes: { id: 'vector_detective', icon: '🕵️‍♂️', en: 'Vector Detective', hi: 'वेक्टर डिटेक्टिव', descEn: 'Found breeding sites', descHi: 'प्रजनन स्थल खोजे' },
            bilingual: { id: 'bilingual', icon: '🈴', en: 'Bilingual Hero', hi: 'द्विभाषी हीरो', descEn: 'Played in Hindi too!', descHi: 'हिंदी में भी खेला!' },
            who_scholar: { id: 'who_scholar', icon: '📘', en: 'WHO Scholar', hi: 'WHO स्कॉलर', descEn: 'High-accuracy clinic answers', descHi: 'क्लिनिक में उच्च सटीकता' },
            champion: { id: 'champion', icon: '🏆', en: 'Village Champion', hi: 'गाँव चैंपियन', descEn: 'Completed all missions', descHi: 'सभी मिशन पूरे किए' }
        };
        function addBadge(key) {
            const b = BADGES[key];
            if (!b) return;
            if (!gameState.badges.includes(b.id)) {
                gameState.badges.push(b.id);
                updateBadgeShelf();
            }
        }
        function updateBadgeShelf() {
            const grid = document.getElementById('badges-grid');
            if (!grid) return;
            const lang = gameState.currentLanguage;
            const order = ['clinic','school','market','homes','bilingual','who_scholar','champion'];
            grid.innerHTML = '';
            order.forEach(k => {
                const b = BADGES[k];
                const owned = gameState.badges.includes(b.id);
                const name = lang==='hi' ? b.hi : b.en;
                const desc = lang==='hi' ? b.descHi : b.descEn;
                const opacity = owned ? 1 : 0.35;
                const card = document.createElement('div');
                card.className = 'badge-card';
                card.innerHTML = `<span class="badge-icon" style="opacity:${opacity}">${b.icon}</span>
                                  <div class="badge-name" style="opacity:${opacity}">${name}</div>
                                  <div class="badge-desc" style="opacity:${opacity}">${desc}</div>`;
                grid.appendChild(card);
            });
        }

        // Mark mission complete with option to keep modal open
        function setMissionCompleted(missionId, opts = { skipClose: false }) {
            // Guard against double-completion
            if (!gameState.completedMissions.includes(missionId)) {
                gameState.completedMissions.push(missionId);
                gameState.missionsCompleted++;
                // Award mission badge
                if (missionId === 'clinic') addBadge('clinic');
                if (missionId === 'school') addBadge('school');
                if (missionId === 'market') addBadge('market');
                if (missionId === 'homes') addBadge('homes');
                // Mark location as completed
                const location = document.getElementById(missionId + '-location') || document.querySelector('.' + missionId);
                if (location) {
                    location.classList.add('completed');
                    location.classList.remove('disabled');
                }
                // Enable next location and update panel text
                const sequence = ['clinic', 'school', 'market', 'homes'];
                const currentIndex = sequence.indexOf(missionId);
                if (currentIndex < sequence.length - 1) {
                    const nextMission = sequence[currentIndex + 1];
                    const nextLocation = document.getElementById(nextMission + '-location');
                    if (nextLocation) {
                        nextLocation.classList.remove('disabled');
                        const badge = nextLocation.querySelector('.priority-badge');
                        if (badge) badge.style.display = 'flex';
                    }
                    const missionTexts = {
                        en: {
                            school: 'Protect vulnerable students at the Village School with limited bed nets!',
                            market: 'Play a fast mosquito catch at the Market to protect everyone!',
                            homes: 'Eliminate deadly mosquito breeding sites in the Family Compounds!'
                        },
                        hi: {
                            school: 'सीमित मच्छरदानी के साथ गांव के विद्यालय में संवेदनशील छात्रों की सुरक्षा करें!',
                            market: 'बाज़ार में तेज़ मच्छर पकड़ो खेल खेलें और सबकी रक्षा करें!',
                            homes: 'पारिवारिक परिसरों में घातक मच्छर प्रजनन स्थलों को समाप्त करें!'
                        }
                    };
                    const textElement = gameState.currentLanguage === 'en' ? document.getElementById('current-mission-text') : document.getElementById('current-mission-text-hi');
                    if (textElement && missionTexts[gameState.currentLanguage][nextMission]) {
                        textElement.textContent = missionTexts[gameState.currentLanguage][nextMission];
                    }
                } else {
                    const completeTexts = {
                        en: 'All missions completed! You are a Malaria Hero! 🎉',
                        hi: 'सभी मिशन पूर्ण! आप एक मलेरिया वीर हैं! 🎉'
                    };
                    const textElement = gameState.currentLanguage === 'en' ? document.getElementById('current-mission-text') : document.getElementById('current-mission-text-hi');
                    if (textElement) textElement.textContent = completeTexts[gameState.currentLanguage];
                    setTimeout(() => { addBadge('champion'); showGameCompletion(); }, 2000);
                }
            }
            // Make sure map reflects newly unlocked next mission
            updateUI();
            if (!opts.skipClose) closeMissionModal();
        }

        // Backward-compatible: complete mission and close
        function completeMission(missionId) {
            setMissionCompleted(missionId, { skipClose: false });
        }

        // Open next mission (won't double-complete if already done)
        function proceedToNextMissionFrom(missionId) {
            const sequence = ['clinic', 'school', 'market', 'homes'];
            const currentIndex = sequence.indexOf(missionId);
            // Ensure completion state without closing
            setMissionCompleted(missionId, { skipClose: true });
            if (currentIndex > -1 && currentIndex < sequence.length - 1) {
                const nextMission = sequence[currentIndex + 1];
                setTimeout(() => { openMission(nextMission); }, 300);
            } else {
                closeMissionModal();
            }
        }

        // Show game completion
        function showGameCompletion() {
            console.log('showGameCompletion called');
            console.log('Lives protected:', gameState.livesProtected);
            console.log('Knowledge points:', gameState.knowledgePoints);
            
            const finalLives = document.getElementById('final-lives');
            const finalPoints = document.getElementById('final-points');
            const finalLivesHi = document.getElementById('final-lives-hi');
            const finalPointsHi = document.getElementById('final-points-hi');
            const completionModal = document.getElementById('completion-modal');
            
            if (finalLives) finalLives.textContent = gameState.livesProtected;
            if (finalPoints) finalPoints.textContent = gameState.knowledgePoints;
            if (finalLivesHi) finalLivesHi.textContent = gameState.livesProtected;
            if (finalPointsHi) finalPointsHi.textContent = gameState.knowledgePoints;
            
            if (completionModal) {
                console.log('Adding active class to completion modal');
                completionModal.classList.add('active');
            } else {
                console.error('Completion modal element not found!');
            }
        }

        // Close completion modal without resetting game
        function closeCompletionModal() {
            const completionModal = document.getElementById('completion-modal');
            if (completionModal) completionModal.classList.remove('active');
        }

        // FIXED: Certificate functions work properly now
        function showCertificateModal() {
            document.getElementById('certificate-modal').style.display = 'flex';
            document.getElementById('certificate-modal').classList.add('active');
            const today = new Date().toLocaleDateString();
            document.getElementById('certificate-date').textContent = today;
            document.getElementById('certificate-date-hi').textContent = today;
        }
        
        function closeCertificateModal() {
            document.getElementById('certificate-modal').style.display = 'none';
            document.getElementById('certificate-modal').classList.remove('active');
        }
        
        function generateCertificate() {
            const nameInputEn = document.getElementById('player-name-input');
            const nameInputHi = document.getElementById('player-name-input-hi');
            const nameInput = gameState.currentLanguage === 'en' ? nameInputEn : nameInputHi;
            const name = nameInput.value.trim() || (gameState.currentLanguage === 'en' ? 'Malaria Hero' : 'मलेरिया वीर');
            
            document.getElementById('certificate-name').textContent = name;
            document.getElementById('certificate-name-hi').textContent = name;
            document.getElementById('certificate-lives').textContent = gameState.livesProtected;
            document.getElementById('certificate-points').textContent = gameState.knowledgePoints;
            
            const successMessage = gameState.currentLanguage === 'en' ? 
                '🎓 Certificate generated! Click "Download PNG" to save it to your device.' :
                '🎓 प्रमाणपत्र तैयार! अपने डिवाइस में सहेजने के लिए "PNG डाउनलोड करें" पर क्लिक करें।';
            alert(successMessage);
        }
        
        function downloadCertificate() {
            const certificate = document.getElementById('certificate-container');
            
            if (window.html2canvas) {
                html2canvas(certificate, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'Malaria-Heroes-Certificate.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    const successMessage = gameState.currentLanguage === 'en' ? 
                        '📥 Certificate downloaded successfully!' :
                        '📥 प्रमाणपत्र सफलतापूर्वक डाउनलोड हो गया!';
                    alert(successMessage);
                }).catch(error => {
                    console.error('Certificate download failed:', error);
                    const errorMessage = gameState.currentLanguage === 'en' ? 
                        '📷 Certificate download failed. Please take a screenshot manually.' :
                        '📷 प्रमाणपत्र डाउनलोड असफल। कृपया मैन्युअल रूप से स्क्रीनशॉट लें।';
                    alert(errorMessage);
                });
            } else {
                const errorMessage = gameState.currentLanguage === 'en' ? 
                    '📷 Screenshot feature not available. Please take a screenshot manually.' :
                    '📷 स्क्रीनशॉट सुविधा उपलब्ध नहीं। कृपया मैन्युअल रूप से स्क्रीनशॉट लें।';
                alert(errorMessage);
            }
        }

        // Restart game
        function restartGame() {
            // Reset all game state
            gameState = {
                currentLanguage: gameState.currentLanguage, // Preserve language choice
                livesProtected: 0,
                knowledgePoints: 0,
                missionsCompleted: 0,
                currentMission: 'clinic',
                completedMissions: []
            };
            
            selectedSymptoms = [];
            protectedStudents = [];
            selectedEducationMethods = [];
            foundBreedingSites = [];
            breedingHelpShown = false;
            
            // Reset UI
            document.getElementById('completion-modal').classList.remove('active');
            
            // Reset locations
            document.querySelectorAll('.location').forEach(location => {
                location.classList.remove('completed');
                if (!location.classList.contains('clinic')) {
                    location.classList.add('disabled');
                    const badge = location.querySelector('.priority-badge');
                    if (badge) badge.style.display = 'none';
                }
            });
            
            const initialTexts = {
                en: 'Visit the Emergency Clinic where a critically ill 8-year-old patient needs immediate medical diagnosis. Lives depend on your expertise!',
                hi: 'आपातकालीन क्लिनिक में जाएं जहां एक गंभीर रूप से बीमार 8 वर्षीय रोगी को तत्काल चिकित्सा निदान की आवश्यकता है। जीवन आपकी विशेषज्ञता पर निर्भर है!'
            };
            
            const textElement = gameState.currentLanguage === 'en' ? 
                document.getElementById('current-mission-text') : 
                document.getElementById('current-mission-text-hi');
            
            if (textElement) {
                textElement.textContent = initialTexts[gameState.currentLanguage];
            }
            
            updateStats();
        }

        // Reset game completely (for GitHub hosting issues)
        function resetGame() {
            // Close any open mission and overlays, return to dashboard
            try { closeMissionModal(); } catch(e) {}
            // Clear all localStorage
            localStorage.removeItem('malariaHeroesProgress');
            localStorage.removeItem('malariaHeroesTutorialComplete');
            
            // Reset game state
            gameState = {
                currentLanguage: gameState.currentLanguage, // Preserve language choice
                livesProtected: 0,
                knowledgePoints: 0,
                missionsCompleted: 0,
                currentMission: 'clinic',
                completedMissions: []
            };
            
            // Reset mission tracking variables
            selectedSymptoms = [];
            protectedStudents = [];
            selectedEducationMethods = [];
            foundBreedingSites = [];
            breedingHelpShown = false;
            breedingAttempts = 0;
            
            // Reset UI
            document.getElementById('completion-modal').classList.remove('active');
            
            // Reset locations
            document.querySelectorAll('.location').forEach(location => {
                location.classList.remove('completed');
                if (!location.classList.contains('clinic')) {
                    location.classList.add('disabled');
                    const badge = location.querySelector('.priority-badge');
                    if (badge) badge.style.display = 'none';
                }
            });
            
            // Reset mission text
            const initialTexts = {
                en: 'Visit the Emergency Clinic where a critically ill 8-year-old patient needs immediate medical diagnosis. Lives depend on your expertise!',
                hi: 'आपातकालीन क्लिनिक में जाएं जहां एक गंभीर रूप से बीमार 8 वर्षीय रोगी को तत्काल चिकित्सा निदान की आवश्यकता है। जीवन आपकी विशेषज्ञता पर निर्भर है!'
            };
            
            const textElement = gameState.currentLanguage === 'en' ? 
                document.getElementById('current-mission-text') : 
                document.getElementById('current-mission-text-hi');
            
            if (textElement) {
                textElement.textContent = initialTexts[gameState.currentLanguage];
            }
            
            // Update stats and UI
            updateStats();
       
     updateUI();
            
            // Show tutorial
            setTimeout(() => {
                startTutorial();
            }, 500);
            
            console.log('Game reset successfully');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            console.log('🌍 Malaria Heroes - Professional Edition Loaded!');
            console.log('📊 Latest WHO 2024 Statistics: 597,000 deaths, 263 million cases');
            console.log('🦟 Vector Control Challenge: 3 wrong attempts max');
            console.log('🇮🇳 Bilingual Support: Accurate Hindi translations');
        });
    </script>

    <!-- 3D Map (Three.js) -->
    

    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- REALISTIC 3D VILLAGE - Simple labels positioned ON buildings -->
    <script>
    (function() {
        console.log('%c[3D Village] Loading realistic village...', 'color: #10b981; font-weight: bold');

        let scene, camera, renderer, controls;
        let buildingLabels = [];
        let clickableBuildings = [];

        window.addEventListener('load', () => setTimeout(initVillage, 150));

        // Simple label text
        const LABELS = {
            clinic: { en: 'Clinic', hi: 'क्लिनिक' },
            school: { en: 'School', hi: 'स्कूल' },
            market: { en: 'Market', hi: 'बाज़ार' },
            home: { en: 'Home', hi: 'घर' }
        };

        function updateLabels(lang) {
            if (!scene || !clickableBuildings.length) return;

            // Remove old labels
            buildingLabels.forEach(label => {
                scene.remove(label);
                if (label.material?.map) label.material.map.dispose();
                if (label.material) label.material.dispose();
            });
            buildingLabels = [];

            // Add new labels directly on each building
            clickableBuildings.forEach(building => {
                const type = building.userData.type;
                if (!type || !LABELS[type]) return;

                const text = LABELS[type][lang];
                const label = createSimpleLabel(text);

                // Position label ON TOP of each building
                const box = new THREE.Box3().setFromObject(building);
                const center = new THREE.Vector3();
                box.getCenter(center);
                const height = box.max.y;

                label.position.set(center.x, height + 1, center.z);
                scene.add(label);
                buildingLabels.push(label);
            });

            console.log('[Labels] Updated to:', lang);
        }

        // Hook language switching
        const originalSwitch = window.switchLanguage;
        window.switchLanguage = function(lang) {
            if (originalSwitch) originalSwitch(lang);
            updateLabels(lang);

            const tutorialOverlay = document.getElementById('tutorial-overlay');
            if (tutorialOverlay?.classList.contains('active')) {
                const step = window.tutorialStep || 0;
                if (typeof showTutorialStep === 'function') showTutorialStep(step);
            }
        };

        function initVillage() {
            try {
                if (typeof THREE === 'undefined') return console.error('[Village] THREE.js not loaded');

                const wrap = document.querySelector('.village-map');
                if (!wrap) return console.error('[Village] Container not found');

                const mapDiv = document.createElement('div');
                mapDiv.id = 'three-map';
                mapDiv.style.cssText = 'position: absolute; inset: 0; z-index: 10; cursor: grab;';
                wrap.prepend(mapDiv);

                const width = wrap.clientWidth;
                const height = Math.max(500, wrap.clientHeight);

                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: 'high-performance' });
                renderer.setSize(width, height);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                mapDiv.appendChild(renderer.domElement);

                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog = new THREE.Fog(0x89CFF0, 80, 220);

                // Camera
                camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 300);
                camera.position.set(40, 35, 40);
                camera.lookAt(0, 3, 0);

                // Controls
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.06;
                controls.rotateSpeed = 0.2;
                controls.zoomSpeed = 0.6;
                controls.minDistance = 25;
                controls.maxDistance = 90;
                controls.maxPolarAngle = Math.PI / 2.1;
                controls.target.set(0, 2, 0);

                mapDiv.addEventListener('mousedown', () => mapDiv.style.cursor = 'grabbing');
                mapDiv.addEventListener('mouseup', () => mapDiv.style.cursor = 'grab');

                // Lighting
                scene.add(new THREE.AmbientLight(0xffffff, 0.8));

                const sunLight = new THREE.DirectionalLight(0xfff9e6, 1.3);
                sunLight.position.set(50, 80, 40);
                sunLight.castShadow = true;
                sunLight.shadow.mapSize.width = 4096;
                sunLight.shadow.mapSize.height = 4096;
                scene.add(sunLight);

                scene.add(new THREE.DirectionalLight(0xffa726, 0.4));
                scene.add(new THREE.HemisphereLight(0x87CEEB, 0x4a9b3f, 0.6));

                // Ocean
                const ocean = new THREE.Mesh(
                    new THREE.CircleGeometry(100, 128),
                    new THREE.MeshStandardMaterial({ color: 0x1565c0, metalness: 0.5, roughness: 0.4 })
                );
                ocean.rotation.x = -Math.PI / 2;
                ocean.position.y = -0.3;
                ocean.receiveShadow = true;
                scene.add(ocean);
                window.ocean = ocean;

                // Island
                const islandGeom = new THREE.CylinderGeometry(35, 38, 12, 80);
                const positions = islandGeom.attributes.position;
                for (let i = 0; i < positions.count; i++) {
                    const y = positions.getY(i);
                    if (Math.abs(y) < 5) positions.setY(i, y + (Math.random() - 0.5) * 0.5);
                }
                positions.needsUpdate = true;
                islandGeom.computeVertexNormals();

                const island = new THREE.Mesh(
                    islandGeom,
                    new THREE.MeshStandardMaterial({ color: 0x8b6f47, roughness: 0.95 })
                );
                island.position.y = -6;
                island.castShadow = true;
                island.receiveShadow = true;
                scene.add(island);

                // Grass
                const grass = new THREE.Mesh(
                    new THREE.CircleGeometry(35, 128),
                    new THREE.MeshStandardMaterial({ color: 0x2d5016, roughness: 0.95 })
                );
                grass.rotation.x = -Math.PI / 2;
                grass.position.y = 0.02;
                grass.receiveShadow = true;
                scene.add(grass);

                // Paths
                const pathMat = new THREE.MeshStandardMaterial({ color: 0x8b7355, roughness: 1.0 });

                const path1 = new THREE.Mesh(new THREE.PlaneGeometry(4, 42), pathMat);
                path1.rotation.x = -Math.PI / 2;
                path1.position.y = 0.03;
                path1.receiveShadow = true;
                scene.add(path1);

                const path2 = new THREE.Mesh(new THREE.PlaneGeometry(42, 4), pathMat);
                path2.rotation.x = -Math.PI / 2;
                path2.position.y = 0.03;
                path2.receiveShadow = true;
                scene.add(path2);

                // Building creator
                function createBuilding(config) {
                    const group = new THREE.Group();
                    group.userData = { missionId: config.missionId, type: config.type, clickable: true };

                    // Foundation
                    const foundation = new THREE.Mesh(
                        new THREE.BoxGeometry(config.width + 0.6, 0.5, config.depth + 0.6),
                        new THREE.MeshStandardMaterial({ color: 0x5a5a5a, roughness: 0.95 })
                    );
                    foundation.position.y = 0.25;
                    foundation.castShadow = true;
                    foundation.receiveShadow = true;
                    group.add(foundation);

                    // Walls
                    const building = new THREE.Mesh(
                        new THREE.BoxGeometry(config.width, config.height, config.depth),
                        new THREE.MeshStandardMaterial({ color: config.color, roughness: 0.85 })
                    );
                    building.position.y = config.height / 2 + 0.5;
                    building.castShadow = true;
                    building.receiveShadow = true;
                    group.add(building);

                    // Roof
                    const roofHeight = config.height * 0.5;
                    const roof = new THREE.Mesh(
                        new THREE.ConeGeometry(Math.max(config.width, config.depth) * 0.85, roofHeight, 4),
                        new THREE.MeshStandardMaterial({ color: 0x6b3410, roughness: 0.95 })
                    );
                    roof.position.y = config.height + 0.5 + roofHeight / 2;
                    roof.rotation.y = Math.PI / 4;
                    roof.castShadow = true;
                    group.add(roof);

                    // Door
                    const door = new THREE.Mesh(
                        new THREE.BoxGeometry(config.width * 0.3, config.height * 0.55, 0.15),
                        new THREE.MeshStandardMaterial({ color: 0x3e2723, roughness: 0.9 })
                    );
                    door.position.set(0, config.height * 0.275 + 0.5, config.depth / 2 + 0.08);
                    door.castShadow = true;
                    group.add(door);

                    // Door handle
                    const handle = new THREE.Mesh(
                        new THREE.SphereGeometry(0.12, 12, 12),
                        new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.1 })
                    );
                    handle.position.set(config.width * 0.1, config.height * 0.3 + 0.5, config.depth / 2 + 0.18);
                    group.add(handle);

                    // Windows
                    const windowMat = new THREE.MeshStandardMaterial({ 
                        color: 0x4fc3f7, metalness: 0.8, roughness: 0.05, 
                        emissive: 0x1565c0, emissiveIntensity: 0.25,
                        transparent: true, opacity: 0.9
                    });

                    [-1, 1].forEach(side => {
                        const win = new THREE.Mesh(
                            new THREE.BoxGeometry(config.width * 0.2, config.height * 0.22, 0.12),
                            windowMat.clone()
                        );
                        win.position.set(side * config.width * 0.35, config.height * 0.68 + 0.5, config.depth / 2 + 0.07);
                        group.add(win);

                        // Window frames
                        const frame = new THREE.Mesh(
                            new THREE.BoxGeometry(config.width * 0.22, config.height * 0.24, 0.08),
                            new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.5 })
                        );
                        frame.position.copy(win.position);
                        frame.position.z -= 0.05;
                        group.add(frame);
                    });

                    // Side windows
                    [-1, 1].forEach(side => {
                        const win = new THREE.Mesh(
                            new THREE.BoxGeometry(config.width * 0.2, config.height * 0.22, 0.12),
                            windowMat.clone()
                        );
                        win.position.set(config.width / 2 + 0.07, config.height * 0.68 + 0.5, side * config.depth * 0.35);
                        win.rotation.y = Math.PI / 2;
                        group.add(win);
                    });

                    // Type-specific features
                    if (config.type === 'clinic') {
                        const crossMat = new THREE.MeshStandardMaterial({ 
                            color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.4 
                        });

                        const crossV = new THREE.Mesh(new THREE.BoxGeometry(0.35, 1.8, 0.25), crossMat);
                        crossV.position.set(0, config.height * 0.72 + 0.5, config.depth / 2 + 0.18);
                        crossV.castShadow = true;
                        group.add(crossV);

                        const crossH = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.35, 0.25), crossMat);
                        crossH.position.set(0, config.height * 0.72 + 0.5, config.depth / 2 + 0.18);
                        crossH.castShadow = true;
                        group.add(crossH);

                        // Emergency lights
                        [-1.5, 1.5].forEach(x => {
                            const light = new THREE.Mesh(
                                new THREE.SphereGeometry(0.15, 16, 16),
                                new THREE.MeshStandardMaterial({ 
                                    color: 0xff0000, emissive: 0xff0000, emissiveIntensity: 0.8 
                                })
                            );
                            light.position.set(x, config.height + 0.5, config.depth / 2);
                            light.userData.isEmergencyLight = true;
                            group.add(light);
                        });
                    }

                    if (config.type === 'school') {
                        // Flag pole
                        const pole = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.15, 0.15, config.height * 1.6, 16),
                            new THREE.MeshStandardMaterial({ color: 0x424242, metalness: 0.7, roughness: 0.3 })
                        );
                        pole.position.set(config.width * 0.65, config.height * 0.8 + 0.5, -config.depth * 0.45);
                        pole.castShadow = true;
                        group.add(pole);

                        // Orange flag
                        const flag = new THREE.Mesh(
                            new THREE.PlaneGeometry(2.2, 1.5),
                            new THREE.MeshStandardMaterial({ color: 0xff6b35, side: THREE.DoubleSide, roughness: 0.7 })
                        );
                        flag.position.set(config.width * 0.65 + 1.1, config.height * 1.5 + 0.5, -config.depth * 0.45);
                        flag.userData.isFlag = true;
                        group.add(flag);

                        // School bell
                        const bell = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.2, 0.3, 0.4, 16),
                            new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.9, roughness: 0.2 })
                        );
                        bell.position.set(-config.width * 0.4, config.height + 0.3, config.depth * 0.4);
                        bell.castShadow = true;
                        group.add(bell);
                    }

                    if (config.type === 'market') {
                        // Awning
                        const awning = new THREE.Mesh(
                            new THREE.BoxGeometry(config.width * 1.4, 0.2, config.depth * 0.7),
                            new THREE.MeshStandardMaterial({ color: 0xd32f2f, roughness: 0.85 })
                        );
                        awning.position.set(0, config.height * 0.4 + 0.5, config.depth * 0.7);
                        awning.castShadow = true;
                        group.add(awning);

                        // Support poles
                        [-1, 1].forEach(side => {
                            const pole = new THREE.Mesh(
                                new THREE.CylinderGeometry(0.15, 0.15, config.height * 0.4, 12),
                                new THREE.MeshStandardMaterial({ color: 0x4e342e, roughness: 0.95 })
                            );
                            pole.position.set(side * config.width * 0.6, config.height * 0.2 + 0.5, config.depth * 0.7);
                            pole.castShadow = true;
                            group.add(pole);
                        });

                        // Market crates with produce
                        [-0.8, 0.8].forEach((offset, i) => {
                            const crate = new THREE.Mesh(
                                new THREE.BoxGeometry(0.9, 0.7, 0.9),
                                new THREE.MeshStandardMaterial({ color: 0x8d6e63, roughness: 0.95 })
                            );
                            crate.position.set(offset * config.width * 0.5, 0.85, config.depth * 0.75);
                            crate.rotation.y = Math.random() * 0.4;
                            crate.castShadow = true;
                            group.add(crate);

                            // Produce
                            const produceColors = [0xff6347, 0xffd700, 0x32cd32];
                            for (let j = 0; j < 5; j++) {
                                const produce = new THREE.Mesh(
                                    new THREE.SphereGeometry(0.12, 12, 12),
                                    new THREE.MeshStandardMaterial({ 
                                        color: produceColors[i % produceColors.length],
                                        roughness: 0.6
                                    })
                                );
                                produce.position.set(
                                    offset * config.width * 0.5 + (Math.random() - 0.5) * 0.5,
                                    1.3 + Math.random() * 0.2,
                                    config.depth * 0.75 + (Math.random() - 0.5) * 0.5
                                );
                                produce.castShadow = true;
                                group.add(produce);
                            }
                        });
                    }

                    if (config.type === 'home') {
                        // Chimney
                        const chimney = new THREE.Mesh(
                            new THREE.BoxGeometry(0.7, 1.8, 0.7),
                            new THREE.MeshStandardMaterial({ color: 0x5d4037, roughness: 0.95 })
                        );
                        chimney.position.set(config.width * 0.3, config.height + 1.4, -config.depth * 0.25);
                        chimney.castShadow = true;
                        group.add(chimney);

                        // Smoke
                        const smokeMat = new THREE.MeshBasicMaterial({ 
                            color: 0xcccccc, transparent: true, opacity: 0.5 
                        });
                        for (let i = 0; i < 5; i++) {
                            const smoke = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), smokeMat.clone());
                            smoke.position.set(
                                config.width * 0.3 + (Math.random() - 0.5) * 0.3,
                                config.height + 2 + i * 0.5,
                                -config.depth * 0.25 + (Math.random() - 0.5) * 0.3
                            );
                            smoke.scale.setScalar(1 + i * 0.2);
                            smoke.userData.isSmoke = true;
                            smoke.userData.offset = i * 0.5;
                            group.add(smoke);
                        }

                        // Fence
                        const fencePosts = 12;
                        for (let i = 0; i < fencePosts; i++) {
                            const angle = (i / fencePosts) * Math.PI * 2;
                            const radius = config.width * 0.85;
                            const post = new THREE.Mesh(
                                new THREE.BoxGeometry(0.12, 1.4, 0.12),
                                new THREE.MeshStandardMaterial({ color: 0x795548, roughness: 0.95 })
                            );
                            post.position.set(Math.cos(angle) * radius, 0.7, Math.sin(angle) * radius);
                            post.castShadow = true;
                            group.add(post);
                        }

                        // Garden flowers
                        const flowerColors = [0xff69b4, 0xffd700, 0xff6347, 0xda70d6];
                        for (let i = 0; i < 8; i++) {
                            const angle = Math.random() * Math.PI * 2;
                            const radius = config.width * 0.7;

                            const stem = new THREE.Mesh(
                                new THREE.CylinderGeometry(0.02, 0.02, 0.6, 8),
                                new THREE.MeshStandardMaterial({ color: 0x228b22 })
                            );
                            stem.position.set(Math.cos(angle) * radius, 0.3, Math.sin(angle) * radius);
                            group.add(stem);

                            const flower = new THREE.Mesh(
                                new THREE.SphereGeometry(0.1, 8, 8),
                                new THREE.MeshStandardMaterial({ color: flowerColors[i % flowerColors.length] })
                            );
                            flower.position.set(Math.cos(angle) * radius, 0.7, Math.sin(angle) * radius);
                            group.add(flower);
                        }
                    }

                    group.position.set(config.x, 0, config.z);
                    clickableBuildings.push(group);
                    return group;
                }

                // Create all buildings
                scene.add(createBuilding({ 
                    missionId: 'clinic', type: 'clinic', color: 0xc62828, 
                    width: 7, height: 8, depth: 6, x: 14, z: 11 
                }));
                scene.add(createBuilding({ 
                    missionId: 'school', type: 'school', color: 0x1565c0, 
                    width: 8, height: 7, depth: 7, x: -14, z: 11 
                }));
                scene.add(createBuilding({ 
                    missionId: 'market', type: 'market', color: 0x2e7d32, 
                    width: 9, height: 6, depth: 7, x: 14, z: -11 
                }));
                scene.add(createBuilding({ 
                    missionId: 'homes', type: 'home', color: 0xf57c00, 
                    width: 5, height: 5, depth: 5, x: -14, z: -11 
                }));

                // Create labels positioned ON buildings
                const currentLang = (window.gameState?.currentLanguage) || 'en';
                updateLabels(currentLang);

                // Trees
                function createTree(x, z) {
                    const tree = new THREE.Group();
                    const trunk = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.4, 0.5, 4, 16),
                        new THREE.MeshStandardMaterial({ color: 0x6b4423, roughness: 0.98 })
                    );
                    trunk.position.y = 2;
                    trunk.castShadow = true;
                    tree.add(trunk);

                    [[0, 4.8, 0, 2], [-0.8, 4.3, 0.8, 1.6], [0.8, 4.3, -0.8, 1.6], 
                     [0, 3.8, 0, 1.7], [-0.6, 3.5, -0.6, 1.3], [0.6, 3.5, 0.6, 1.3]].forEach(([px, py, pz, r]) => {
                        const foliage = new THREE.Mesh(
                            new THREE.SphereGeometry(r, 16, 16),
                            new THREE.MeshStandardMaterial({ color: 0x1b5e20, roughness: 0.9 })
                        );
                        foliage.position.set(px, py, pz);
                        foliage.castShadow = true;
                        tree.add(foliage);
                    });

                    tree.position.set(x, 0, z);
                    tree.scale.setScalar(0.9 + Math.random() * 0.3);
                    return tree;
                }

                [[24, 24], [-24, 24], [24, -24], [-24, -24], [0, 26], [26, 0], [0, -26], [-26, 0],
                 [12, 24], [-12, 24], [24, 12], [24, -12], [-12, -24], [-24, -12], [12, -24], [-24, 12],
                 [18, 20], [-18, 20], [18, -20], [-18, -20]].forEach(([x, z]) => scene.add(createTree(x, z)));

                // Rocks
                for (let i = 0; i < 15; i++) {
                    const rock = new THREE.Mesh(
                        new THREE.DodecahedronGeometry(0.35 + Math.random() * 0.5, 0),
                        new THREE.MeshStandardMaterial({ color: 0x616161, roughness: 0.95 })
                    );
                    const angle = (i / 15) * Math.PI * 2;
                    const radius = 29 + Math.random() * 5;
                    rock.position.set(Math.cos(angle) * radius, 0.2, Math.sin(angle) * radius);
                    rock.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, Math.random() * Math.PI);
                    rock.castShadow = true;
                    rock.receiveShadow = true;
                    scene.add(rock);
                }

                // Clouds
                const cloudGroup = new THREE.Group();
                for (let i = 0; i < 15; i++) {
                    const cloud = new THREE.Mesh(
                        new THREE.SphereGeometry(3.5 + Math.random() * 1.5, 12, 12),
                        new THREE.MeshStandardMaterial({ 
                            color: 0xffffff, transparent: true, opacity: 0.88, roughness: 1 
                        })
                    );
                    cloud.position.set(
                        (Math.random() - 0.5) * 120, 
                        40 + Math.random() * 25, 
                        (Math.random() - 0.5) * 120
                    );
                    cloud.scale.set(1.6 + Math.random() * 0.6, 0.7, 1.6 + Math.random() * 0.6);
                    cloudGroup.add(cloud);
                }
                scene.add(cloudGroup);

                // Grass patches
                for (let i = 0; i < 30; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = Math.random() * 28 + 5;
                    const patch = new THREE.Mesh(
                        new THREE.CircleGeometry(0.3 + Math.random() * 0.4, 8),
                        new THREE.MeshStandardMaterial({ color: 0x1b5e20, roughness: 0.95 })
                    );
                    patch.rotation.x = -Math.PI / 2;
                    patch.position.set(Math.cos(angle) * radius, 0.04, Math.sin(angle) * radius);
                    patch.receiveShadow = true;
                    scene.add(patch);
                }

                console.log('[Village] Realistic village created');

                // Click handler
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                let hoveredBuilding = null;

                renderer.domElement.addEventListener('click', (event) => {
                    const rect = renderer.domElement.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);
                    const allMeshes = [];
                    clickableBuildings.forEach(b => b.traverse(obj => { if (obj.isMesh) allMeshes.push(obj); }));

                    const intersects = raycaster.intersectObjects(allMeshes);
                    if (intersects.length > 0) {
                        let building = intersects[0].object;
                        while (building && !building.userData.missionId) building = building.parent;

                        if (building?.userData.missionId) {
                            building.traverse(obj => {
                                if (obj.isMesh && obj.material && !obj.userData.isFlag && !obj.userData.isSmoke) {
                                    obj.material.emissive = new THREE.Color(0xffeb3b);
                                    obj.material.emissiveIntensity = 0.6;
                                    setTimeout(() => {
                                        obj.material.emissive = new THREE.Color(0x000000);
                                        obj.material.emissiveIntensity = 0;
                                    }, 400);
                                }
                            });

                            setTimeout(() => {
                                const mid = building.userData.missionId;
                                console.log('[CLICK] Trying to open:', mid);

                                // Try all possible ways to call openMission
                                try {
                                    if (typeof window.openMission === 'function') {
                                        console.log('[CLICK] Using window.openMission');
                                        window.openMission(mid);
                                    } else if (typeof openMission === 'function') {
                                        console.log('[CLICK] Using global openMission');
                                        openMission(mid);
                                    } else {
                                        console.log('[CLICK] Direct modal open fallback');
                                        const modal = document.getElementById('mission-modal');
                                        if (modal) {
                                            modal.querySelectorAll('.mission-section').forEach(s => s.style.display = 'none');
                                            const target = document.getElementById(mid);
                                            if (target) {
                                                target.style.display = 'block';
                                                modal.classList.add('active');
                                                document.body.style.overflow = 'hidden';
                                                console.log('[CLICK] ✓ Opened via fallback');
                                            }
                                        }
                                    }
                                } catch (err) {
                                    console.error('[CLICK] Error:', err);
                                }
                            }, 200);
                        }
                    }
                });

                // Hover effect
                renderer.domElement.addEventListener('mousemove', (event) => {
                    const rect = renderer.domElement.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                    raycaster.setFromCamera(mouse, camera);
                    const allMeshes = [];
                    clickableBuildings.forEach(b => b.traverse(obj => { if (obj.isMesh) allMeshes.push(obj); }));

                    const intersects = raycaster.intersectObjects(allMeshes);

                    if (hoveredBuilding) {
                        hoveredBuilding.traverse(obj => {
                            if (obj.isMesh && obj.material && !obj.userData.isFlag && !obj.userData.isSmoke) {
                                obj.material.emissive = new THREE.Color(0x000000);
                                obj.material.emissiveIntensity = 0;
                            }
                        });
                        hoveredBuilding = null;
                    }

                    if (intersects.length > 0) {
                        let building = intersects[0].object;
                        while (building && !building.userData.missionId) building = building.parent;

                        if (building?.userData.missionId) {
                            hoveredBuilding = building;
                            mapDiv.style.cursor = 'pointer';

                            building.traverse(obj => {
                                if (obj.isMesh && obj.material && !obj.userData.isFlag && !obj.userData.isSmoke) {
                                    obj.material.emissive = new THREE.Color(0xffc107);
                                    obj.material.emissiveIntensity = 0.25;
                                }
                            });
                        } else {
                            mapDiv.style.cursor = 'grab';
                        }
                    } else {
                        mapDiv.style.cursor = 'grab';
                    }
                });

                // Animation loop
                let time = 0;
                function animate() {
                    requestAnimationFrame(animate);
                    time += 0.003;

                    cloudGroup.rotation.y = time * 0.012;

                    scene.traverse(obj => {
                        if (obj.userData.isFlag && obj.geometry?.attributes?.position) {
                            const positions = obj.geometry.attributes.position;
                            for (let j = 0; j < positions.count; j++) {
                                const x = positions.getX(j);
                                positions.setZ(j, Math.sin(x * 2 + time * 3) * 0.15);
                            }
                            positions.needsUpdate = true;
                        }

                        if (obj.userData.isSmoke) {
                            obj.position.y += Math.sin(time * 2 + obj.userData.offset) * 0.002;
                            obj.material.opacity = 0.5 + Math.sin(time * 2 + obj.userData.offset) * 0.2;
                        }

                        if (obj.userData.isEmergencyLight) {
                            obj.material.emissiveIntensity = 0.8 + Math.sin(time * 5) * 0.4;
                        }
                    });

                    buildingLabels.forEach(label => label.lookAt(camera.position));
                    window.ocean.position.y = -0.3 + Math.sin(time * 0.4) * 0.06;

                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();

                console.log('[Village] ✅ Complete with labels positioned ON buildings');

                // Resize
                window.addEventListener('resize', () => {
                    const newWidth = wrap.clientWidth;
                    const newHeight = Math.max(500, wrap.clientHeight);
                    camera.aspect = newWidth / newHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(newWidth, newHeight);
                });

            } catch (error) {
                console.error('[Village] Error:', error);
            }
        }

        // Create simple text label
        function createSimpleLabel(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');

            // Semi-transparent background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
            ctx.fillRect(0, 0, 256, 64);

            // White text
            ctx.font = 'bold 32px Inter, Arial';
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 128, 32);

            const texture = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
                map: texture, 
                depthTest: false,
                transparent: true 
            }));
            sprite.scale.set(6, 1.5, 1);

            return sprite;
        }

    })();
    </script>

    <!-- Mission Progression & Tooltips -->
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        // Mission progression
        window.proceedToNextMissionFromclinic = () => { closeMissionModal(); setTimeout(() => openMission('school'), 300); };
        window.proceedToNextMissionFromschool = () => { closeMissionModal(); setTimeout(() => openMission('market'), 300); };
        window.proceedToNextMissionFrommarket = () => { closeMissionModal(); setTimeout(() => openMission('homes'), 300); };
        window.proceedToNextMissionFromhomes = () => { closeMissionModal(); };

        // Override openMission
        const originalOpenMission = window.openMission;
        window.openMission = function(missionId) {
            const modal = document.getElementById('mission-modal');
            if (modal) {
                modal.querySelectorAll('.mission-section').forEach(s => s.style.display = 'none');
                const target = document.getElementById(missionId);
                if (target) {
                    target.style.display = 'block';
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
        };

        // Breeding ground tooltips
        setTimeout(() => {
            const items = document.querySelectorAll('.compound-item, .breeding-site');
            const tooltips = {
                'tires': 'Old Tires - Breeding site',
                'bucket': 'Bucket - Standing water',
                'flower-pot': 'Flower Pot - Water tray',
                'gutter': 'Gutter - Trapped water',
                'tank': 'Tank - Uncovered'
            };
            items.forEach(item => {
                const site = item.getAttribute('data-site');
                if (site && tooltips[site]) {
                    item.setAttribute('title', tooltips[site]);
                    item.style.cursor = 'help';
                }
            });
        }, 1500);

        console.log('[Fixes] ✅ All fixes applied');
    });
    </script>
</body>
</html>
